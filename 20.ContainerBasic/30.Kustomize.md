# Kustomize 개요

Kustomize는 Kubernetes 애플리케이션의 YAML 파일을 템플릿화하지 않고도 구성할 수 있는 도구입니다. Kustomize는 오버레이(overlay) 개념을 사용하여 기본 리소스를 수정하고 환경별로 다른 설정을 적용할 수 있습니다.

# 주요 개념

- Base: 공통 리소스를 정의하는 기본 디렉토리입니다.
- Overlay: 특정 환경(dev, prod 등)에 맞게 base 리소스를 수정하는 디렉토리입니다.
- kustomization.yaml: Kustomize 설정 파일로, 리소스, 패치, 설정 등을 정의합니다.
- gitops: argocd application에 대한 설정을 정의하는 디렉토리입니다. 

# 디렉토리 구조

예제 어플리케이션인 mvp-springboot-jdk17의 manifests 디렉토리 구조입니다. 

```bash
./manifests
├── base
│   ├── deployment.yaml
│   ├── gitops
│   │   ├── argocd-app.yaml
│   │   ├── argocd-repo-secret.yaml
│   │   └── kustomization.yaml
│   ├── ingress.yaml
│   ├── kustomization.yaml
│   └── service.yaml
└── overlays
    ├── dev
    │   ├── deployment-patches.yaml
    │   ├── gitops
    │   │   ├── argocd-app-patches.yaml
    │   │   ├── argocd-repo-secret-patches.yaml
    │   │   └── kustomization.yaml
    │   ├── ingress-patches.yaml
    │   └── kustomization.yaml
    └── prd
        ├── deployment-patches.yaml
        ├── gitops
        │   ├── argocd-app-patches.yaml
        │   ├── argocd-repo-secret-patches.yaml
        │   └── kustomization.yaml
        ├── ingress-patches.yaml
        └── kustomization.yaml
```

# manifests

예제 어플리케이션인 mvp-springboot-jdk17의 쿠버네티스 배포용 manifests와 gitops인 ArgoCD Application의 manifests가 포함된 디렉토리

## base

공통 리소스를 정의하는 base 디렉토리

### deployment.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mvp-springboot-jdk17
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mvp-springboot-jdk17
  template:
    metadata:
      labels:
        app: mvp-springboot-jdk17
    spec:
      containers:
      - name: mvp-springboot-jdk17
        image: axccoe/mvp-springboot-jdk17
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        readinessProbe:
          failureThreshold: 3
          successThreshold: 1
          httpGet:
              path: /actuator/health/readiness
              port: 8080
              scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 3
        livenessProbe:
          failureThreshold: 3
          successThreshold: 1
          httpGet:
              path: /actuator/health/liveness
              port: 8080
              scheme: HTTP
          initialDelaySeconds: 20
          periodSeconds: 3
```

### ingress.yaml

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mvp-springboot-jdk17
spec:
  ingressClassName: nginx
  rules:
  - host: mvp-springboot-jdk17.20.249.190.36.nip.io
    http:
      paths:
      - pathType: Prefix
        path: /
        backend:
          service:
            name: mvp-springboot-jdk17
            port:
              number: 8080
```

### kustomization.yaml

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

images:
- name: axccoe/mvp-springboot-jdk17

resources:
- ./deployment.yaml
- ./service.yaml
- ./ingress.yaml
```

### service.yaml

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mvp-springboot-jdk17
  labels:
    app: mvp-springboot-jdk17
spec:
  ports:
  - port: 8080
    targetPort: 8080
    name: mvp-springboot-jdk17
  selector:
    app: mvp-springboot-jdk17
```

---

### gitops

ArgoCD Application에 대한 공통 리소스를 관리합니다.

#### argocd-app.yaml

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mvp-springboot-jdk17
  namespace: argocd
spec:
  destination:
    name: in-cluster
    namespace: mvp-springboot-dev
    server: ''
  source:
    path: manifests/overlays/dev
    repoURL: https://github.com/axccoe/mvp-springboot-jdk17.git
    targetRevision: main
  sources: []
  project: default
  syncPolicy:
    automated: null
    syncOptions:
      - CreateNamespace=true
```

#### argocd-repo-secret.yaml

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mvp-springboot-jdk17
  namespace: argocd
  labels:
    argocd.argoproj.io/secret-type: repository
data: 
  password: github_pat_token
  username: github_user
stringData:
  name: mvp-springboot-jdk17
  url: https://github.com/axccoe/mvp-springboot-jdk17
  insecure: "true"
  project: default
  type: git
type: Opaque
```

#### kustomization.yaml

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ./argocd-app.yaml
- ./argocd-repo-secret.yaml
```

---

## overlays

특정 환경(dev, prod 등)에 맞게 base 리소스를 수정하는 디렉토리

### dev

개발 환경에 맞게 base 리소스를 수정하는 디렉토리 

#### deployment-patches.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mvp-springboot-jdk17
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: mvp-springboot-jdk17
    spec:
      containers:
      - env:
        - name: JAVA_OPTS
          value: -Dspring.profiles.active=dev
        name: mvp-springboot-jdk17
```

#### ingress-patches.yaml

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mvp-springboot-jdk17
spec:
  ingressClassName: nginx
  rules:
  - host: mvp-springboot-jdk17-dev.20.249.190.36.nip.io
    http:
      paths:
      - pathType: Prefix
        path: /
        backend:
          service:
            name: mvp-springboot-jdk17
            port:
              number: 8080
```

#### kustomization.yaml

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mvp-springboot-dev

resources:
- ../../base

patches:
- path: ./deployment-patches.yaml
  target:
    kind: Deployment
- path: ./ingress-patches.yaml
  target:
    kind: Ingress

images:
- name: axccoe/mvp-springboot-jdk17
  newName: tiuaxcoetmpacr.azurecr.io/axccoe/mvp-springboot-jdk17-dev
  newTag: "20240902074809"

resources:
- ../../base
```

---

#### gitops

개발 환경에 맞게 ArgoCD 어플리케이션의 base 리소스를 수정하는 디렉토리


##### argocd-app-patches.yaml

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mvp-springboot-jdk17
spec:
  destination:
    namespace: mvp-springboot-dev
  source:
    path: manifests/overlays/dev
```

##### argocd-repo-secret-patches.yaml

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mvp-springboot-jdk17
data:
  password: Z2l0aHV******MUFKUUxLWFkwdjNaRmhXa0sxdHJoX3p3S3pKU2xQUFFlVHFxSXpKT2FFcXRaWDFDWUFhRm5ib2ZxcDVSUjVaNkpBVDc1S1BTQllWdExRdkZu
  username: bm9pc****m9pdG9u
stringData:
  name: mvp-springboot-jdk17-dev
  url: https://github.com/axccoe/mvp-springboot-jdk17
```

##### kustomization.yaml

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: argocd

nameSuffix: -dev

patches:
- path: ./argocd-app-patches.yaml
  target:
    kind: Application
- path: ./argocd-repo-secret-patches.yaml
  target:
    kind: Secret

resources:
- ../../../base/gitops
```

---

### prd

운영 환경에 맞게 base 리소스를 수정하는 디렉토리

#### deployment-patches.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mvp-springboot-jdk17
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: mvp-springboot-jdk17
    spec:
      containers:
      - env:
        - name: JAVA_OPTS
          value: -Dspring.profiles.active=prd
        name: mvp-springboot-jdk17
```

#### ingress-patches.yaml

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mvp-springboot-jdk17
spec:
  ingressClassName: nginx
  rules:
  - host: mvp-springboot-jdk17-prd.20.249.190.36.nip.io
    http:
      paths:
      - pathType: Prefix
        path: /
        backend:
          service:
            name: mvp-springboot-jdk17
            port:
              number: 8080
```

#### kustomization.yaml

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mvp-springboot-prd

resources:
- ../../base

patches:
- path: ./deployment-patches.yaml
  target:
    kind: Deployment
- path: ./ingress-patches.yaml
  target:
    kind: Ingress

images:
- name: axccoe/mvp-springboot-jdk17
  newName: tiuaxcoetmpacr.azurecr.io/axccoe/mvp-springboot-jdk17-prd
  newTag: "20240903020035"

resources:
- ../../base
```

---

#### gitops

운영 환경에 맞게 ArgoCD 어플리케이션의 base 리소스를 수정하는 디렉토리

##### argocd-app-patches.yaml

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mvp-springboot-jdk17
spec:
  destination:
    namespace: mvp-springboot-prd
  source:
    path: manifests/overlays/prd
```

##### argocd-repo-secret-patches.yaml

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mvp-springboot-jdk17
data:
  password: Z2l0aHViX3B**************3p3S3pKU2xQUFFlVHFxSXpKT2FFcXRaWDFDWUFhRm5ib2ZxcDVSUjVaNkpBVDc1S1BTQllWdExRdkZu
  username: bm9p*******dG9u
stringData:
  name: mvp-springboot-jdk17-prd
  url: https://github.com/axccoe/mvp-springboot-jdk17
```

##### kustomization.yaml

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: argocd

nameSuffix: -prd

patches:
- path: ./argocd-app-patches.yaml
  target:
    kind: Application
- path: ./argocd-repo-secret-patches.yaml
  target:
    kind: Secret

resources:
- ../../../base/gitops
```

# GitOps manifest 적용

ArgoCD Application 배포

```bash
kustomize build --enable-helm ./manifests/overlays/<env-name>/gitops | kubectl apply -f -
```

ArgoCD Application 배포 후 ArgoCD UI를 사용해 예제 어플리케이션인 mvp-springboot-jdk17을 쿠버네티스에 배포합니다.

# 베스트 프랙티스

- Base와 Overlay 분리: 공통 리소스는 base에, 환경별 설정은 overlay에 정의합니다.
- 환경별 패치 사용: 환경별로 다른 설정은 패치를 사용하여 적용합니다.
- 명확한 디렉토리 구조: base와 overlay 디렉토리를 명확히 구분하여 관리합니다.
- 버전 관리: kustomization.yaml 파일과 리소스 파일을 버전 관리 시스템에 포함시켜 변경 이력을 추적합니다.
- CI/CD 통합: Kustomize를 CI/CD 파이프라인에 통합하여 자동화된 배포를 구현합니다.
  이 가이드를 통해 frontend와 backend 애플리케이션을 dev와 prod 환경에 맞게 구성할 수 있습니다.


# 참고사이트

- [Introduction to Kustomize](https://kubectl.docs.kubernetes.io/guides/introduction/kustomize/)