# AKS ACR 연결



# 1. 개요

AKS 클러스터에서 Azure Container Registry (ACR)에서 이미지를 가져올 권한을 설정하는 방법에 대해서 살펴본다.

일반적으로 이를 위해 `Azure AD`의 `Managed Identity` 또는 `Service Principal`을 사용하여 AKS 클러스터에 ACR의 `pull` 권한을 부여할 수 있다.



# 2. AKS Managed Identity 에 ACR등록

가장 간단한 방법은 Azure CLI를 사용하여 AKS 클러스터의 `Managed Identity`에 ACR의 `pull` 권한을 부여하는 것이다.

* **Managed Identity**는 Azure 리소스에 대한 인증을 간소화하기 위해 사용되는 Azure AD 서비스이다. AKS 클러스터는 Managed Identity를 통해 Azure AD에서 인증을 받아 다른 Azure 리소스에 접근할 수 있다.
* AKS 클러스터를 생성할 때, AKS는 Azure AD에서 관리형 ID를 생성할 수 있다. 이 ID를 사용하여 AKS는 Azure Container Registry와 같은 다른 Azure 리소스에 접근할 수 있다.





## 1) AKS 클러스터에 권한 부여

먼저, AKS 클러스터에 연결된 Managed Identity 에 ACR 등록한다.



### (1) 구독 확인

```bash
# 구독 목록
$ az account list -o table

Name         CloudName    SubscriptionId                        TenantId                              State    IsDefault
-----------  -----------  ------------------------------------  ------------------------------------  -------  -----------
ce-pg-study  AzureCloud   0cbb9123-6397-4a37-97d1-8efa0a25043b  a3870566-f011-4691-aa51-5b988c51c03a  Enabled  False
axcoe        AzureCloud   1d6c45e0-bd9f-4771-bb67-36616452f239  a3870566-f011-4691-aa51-5b988c51c03a  Enabled  True


# 구독 변경
$ az account set --subscription axcoe

```



### (2) ACR 확인

```bash
# acr 확인
$ az acr list -o table

NAME            RESOURCE GROUP    LOCATION      SKU      LOGIN SERVER               CREATION DATE         ADMIN ENABLED
--------------  ----------------  ------------  -------  -------------------------  --------------------  ---------------
axcoeyjacr      axcoe-yj-rg       koreacentral  Basic    axcoeyjacr.azurecr.io      2024-08-22T12:19:16Z  True
axcoeyjpracr    axcoe-yj-rg       koreacentral  Premium  axcoeyjpracr.azurecr.io    2024-08-22T13:34:22Z  True
tiuaxcoetmpacr  tiu-axcoe-rg      koreacentral  Premium  tiuaxcoetmpacr.azurecr.io  2024-08-08T05:10:27Z  True


# ACR 리소스 ID 가져오기

ACR_NAME=axcoeyjacr

$ az acr show --name $ACR_NAME --query "id" --output tsv
/subscriptions/0cbb9123-6397-4a37-97d1-8efa0a25043b/resourceGroups/cepg-aa-std-rg/providers/Microsoft.ContainerRegistry/registries/cepgstapacr

/subscriptions/1d6c45e0-bd9f-4771-bb67-36616452f239/resourceGroups/axcoe-yj-rg/providers/Microsoft.ContainerRegistry/registries/axcoeyjpracr



$ ACR_ID=$(az acr show --name $ACR_NAME --query "id" --output tsv)
  echo $ACR_ID


```



### (3) AKS 설정

```bash
$ az aks list -o table


Name                     Location      ResourceGroup    KubernetesVersion    CurrentKubernetesVersion    ProvisioningState    Fqdn
-----------------------  ------------  ---------------  -------------------  --------------------------  -------------------  ------------------------------------------------------------------
tiu-axcoe-pri-aks        koreacentral  tiu-axcoe-rg     1.29                 1.29.7                      Succeeded            tiu-axcoe--tiu-axcoe-rg-1d6c45-vjqqk97w.hcp.koreacentral.azmk8s.io
tiu-axcoe-pub-cluster    koreacentral  tiu-axcoe-rg     1.29                 1.29.7                      Succeeded            tiu-axcoe--tiu-axcoe-rg-1d6c45-y8vbv466.hcp.koreacentral.azmk8s.io
tiu-axcoe-tmp-aks-clstr  koreacentral  tiu-axcoe-rg     1.29                 1.29.7                      Succeeded            tiu-axcoe-pet-malamute-6ocezwud.hcp.koreacentral.azmk8s.io
axcoeyjaks               koreacentral  axcoe-yj-rg      1.29                 1.29.7                      Succeeded            axcoeyjaks-axcoe-yj-rg-1d6c45-twzorgp4.hcp.koreacentral.azmk8s.io


# 변수 설정
ACR_NAME=axcoeyjacr
RESOURCE_GROUP=axcoe-yj-rg
AKS_CLUSTER_NAME=axcoeyjaks


# AKS 클러스터의 Managed Identity에 ACR의 pull 권한 부여
$ az aks update -n $AKS_CLUSTER_NAME -g $RESOURCE_GROUP --attach-acr $ACR_NAME



```

이 명령어는 AKS 클러스터의 Managed Identity에 ACR에 접근할 수 있는 `pull` 권한을 자동으로 부여한다.







### (4) [참고] ACR에 `pull` 권한 부여 수동 설정 (선택 사항)

만약 수동으로 권한을 설정하려는 경우, 아래 명령어를 사용할 수 있다.

```bash
# AKS 클러스터의 Managed Identity 또는 Service Principal ID 가져오기
CLIENT_ID=$(az aks show -g $RESOURCE_GROUP -n $AKS_CLUSTER_NAME --query "identityProfile.kubeletidentity.clientId" --output tsv)

# ACR에 `AcrPull` 역할 부여
$ az role assignment create --assignee $CLIENT_ID --role "AcrPull" --scope $ACR_ID


```



## 2) **AKS에서 ACR pull TEST**

권한이 부여된 이후, AKS 클러스터에서 ACR에 있는 이미지를 문제 없이 가져올 수 있어야 한다. 

```bash
$ kubectl create deploy userlist --image=axcoeyjacr.azurecr.io/ssongman/userlist:v1

```



## 3) **Managed Identity 사용 여부 확인**

`az aks show` 명령어를 사용하여 AKS 클러스터에 Managed Identity가 설정되어 있는지 확인할 수 있다.

```bash
AKS_CLUSTER_NAME=axcoeyjaks
RESOURCE_GROUP=axcoe-yj-rg

$ az aks show -n $AKS_CLUSTER_NAME -g $RESOURCE_GROUP --query "identity"

{
  "delegatedResources": null,
  "principalId": "90f5852b-26ba-4fb6-86d6-7a27fa3f384d",
  "tenantId": "a3870566-f011-4691-aa51-5b988c51c03a",
  "type": "SystemAssigned",
  "userAssignedIdentities": null
}


```

Managed Identity가 없을 경우, `SystemAssigned` 또는 `UserAssigned` Managed Identity를 추가로 설정해야 할 수도 있다.







# 3. Image pull secret

AKS에서 Azure Container Registry (ACR)의 이미지를 `imagePullSecrets`를 사용하여 pull하는 방법은, Kubernetes의 기본적인 비공개 레지스트리 인증 방식이다. 이 방식에서는 ACR에 접근할 수 있는 자격 증명(도커 로그인 정보)을 Kubernetes Secret으로 저장하고, 이를 Pod의 `imagePullSecrets`로 지정하여 이미지를 pull한다.



## 1) **ACR 로그인 정보 가져오기**

아래 두가지 중 하나로 정보를 획득 할 수 있다.



### (1) ACR 접근 user/pass 획득

ACR에 접근할 수 있는 관리자 계정의 사용자 이름과 비밀번호를 얻어야 한다. 다음 명령어를 사용하여 ACR의 자격 증명을 추출한다.

```bash
$ az acr credential show --name axcoeyjacr

{
  "passwords": [
    {
      "name": "password",
      "value": "/HgYhpO9uY0Osf3XxT/M0L+9ARBVxaFuYHyvkdMS8E+ACRBGYz52"
    },
    {
      "name": "password2",
      "value": "YgxvzDemPaVGPeDS6lQniOEQGYEbTag5jHGSRdGw/7+ACRBF443B"
    }
  ],
  "username": "axcoeyjacr"
}


```



### (2) service principal 생성

```bash
ACR_NAME=axcoeyjacr

# ACR RESOURCE ID 확인
$ az acr show --name $ACR_NAME --query id --output tsv

/subscriptions/1d6c45e0-bd9f-4771-bb67-36616452f239/resourceGroups/axcoe-yj-rg/providers/Microsoft.ContainerRegistry/registries/axcoeyjacr


# RESOURCE ID Set
ACR_RESOURCE_ID=$(az acr show --name $ACR_NAME --query id --output tsv)
echo $ACR_RESOURCE_ID


SP_NAME=myAcrSp
$ az ad sp create-for-rbac --name SP_NAME --scope $ACR_RESOURCE_ID --role acrpull




```

- 생성된 Service Principal은 ACR에서 이미지를 pull할 수 있는 권한을 갖도록 설정한다.
- 잘 안된다.    AuthorizationFailed 오류 발생!  그냥 위에 것으로 하자.





## 2) **Kubernetes Secret 생성**

ACR 자격 증명을 Kubernetes Secret으로 저장한다. `kubectl` 명령어를 사용하여 다음과 같이 Secret을 생성할 수 있다.

```bash

SECRET_NAME=acr-secret
ACR_NAME=axcoeyjacr
admin_username=axcoeyjacr
password_value=/HgYhpO9uY0Osf3XxT/M0L+9ARBVxaFuYHyvkdMS8E+ACRBGYz52
my_email=ssongmantop@gmail.com


$ kubectl create secret docker-registry $SECRET_NAME \
  --docker-server=$ACR_NAME.azurecr.io \
  --docker-username=$admin_username \
  --docker-password=$password_value \
  --docker-email=$my_email


# 확인
$ kubectl get secret $SECRET_NAME --output="jsonpath={.data.\.dockerconfigjson}" | base64 --decode

```

- **`<SECRET_NAME>`**: Kubernetes Secret의 이름이다. 예: `acr-secret`.
- **`<ACR_NAME>`**: Azure Container Registry의 이름이다.
- **`<admin_username>`**: ACR 자격 증명의 사용자 이름이다.
- **`<password_value>`**: ACR 자격 증명의 비밀번호이다.
- **`<your_email>`**: Docker 레지스트리의 이메일 주소이다. 일반적으로 이메일은 필수 입력 사항이 아니므로 사용하지 않더라도 상관없다.





## 3) **Pod 또는 Deployment에서 `imagePullSecrets` 사용**

이제, 생성한 Secret을 사용하여 Pod이나 Deployment에서 ACR 이미지를 pull할 수 있도록 설정한다.

**Pod의 예시 YAML 파일:**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp
spec:
  containers:
  - name: myapp-container
    image: myacr.azurecr.io/myapp:latest
  imagePullSecrets:
  - name: acr-secret
```

**Deployment의 예시 YAML 파일:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp-container
        image: myacr.azurecr.io/myapp:latest
      imagePullSecrets:
      - name: acr-secret
```

이 설정은 `myacr.azurecr.io`에서 `myapp:latest` 이미지를 pull할 때, 생성한 `acr-secret`을 사용하도록 Kubernetes에 지시한다.



## 4) **배포 및 확인**

위의 YAML 파일을 사용하여 Deployment를 배포한다.

```bash
kubectl apply -f deployment.yaml
```

배포가 성공적으로 이루어지면, 지정된 ACR로부터 이미지를 pull하여 Pod가 실행된다. 이를 확인하려면 다음 명령어를 사용한다.

```bash
kubectl get pods
```

Pod가 정상적으로 실행 중인지 확인한다. 만약 이미지 pull에 문제가 있을 경우, 로그를 확인하여 원인을 파악할 수 있다.



## 5) **요약**

`imagePullSecrets` 방식은 ACR에 대한 자격 증명을 Kubernetes Secret으로 저장하고, Pod에서 이미지를 pull할 때 이 Secret을 사용하는 방식이다. 이 방식은 ACR과 같은 비공개 Docker 레지스트리에서 이미지를 pull할 때 일반적으로 사용된다.

- **장점**: 특정 Pod나 Deployment에 대해 세밀하게 자격 증명을 관리할 수 있다.
- **단점**: 자격 증명 관리가 번거로울 수 있으며, 보안에 민감한 환경에서는 Managed Identity를 사용하는 방법이 더 적합할 수 있다.

이 방법을 통해 AKS에서 ACR 이미지를 pull하여 배포할 수 있다.







