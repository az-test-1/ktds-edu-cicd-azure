# ACR

[[_TOC_]]



# 1. 개요



**ACR**는 **Azure Container Registry**의 약자로, Microsoft Azure에서 제공하는 **도커 컨테이너 이미지 저장소**이다. Azure에서 애플리케이션을 배포할 때 필요한 컨테이너 이미지를 저장하고 관리할 수 있는 안전하고 확장 가능한 플랫폼이다.



### 주요 특징
* **컨테이너 이미지 저장**: ACR은 도커 컨테이너 이미지를 저장하고, 이 이미지를 Azure Kubernetes Service(AKS), Azure App Service, Azure Functions, 또는 다른 클라우드 서비스에 배포할 수 있게 한다.

* **보안 기능**: Azure Active Directory(AAD) 인증을 통한 **권한 부여**, 이미지 **서명** 및 **스캔** 등의 보안 기능을 지원하여, 신뢰할 수 있는 배포 환경을 제공한다.

* **멀티 리전 지원**: ACR은 글로벌하게 여러 리전을 지원하여, 사용자가 어디에서나 낮은 레이턴시로 이미지를 가져올 수 있도록 한다.
* **빌드 기능**: ACR에는 **Azure Container Registry Tasks**라는 도구가 포함되어 있어, 이미지를 자동으로 빌드하고 태깅할 수 있다.
* **OCI(오픈 컨테이너 이니셔티브) 아티팩트 지원**: ACR은 OCI 기반의 아티팩트를 저장하고 관리할 수 있으며, 이를 통해 헬름 차트, Singularity 이미지 등 다양한 컨테이너 형식의 아티팩트를 저장할 수 있다.



이미지를 ACR(Azure Container Registry)에 push 하고 배포하는 방법을 살펴본다.



# 2. 사전 준비

* **Azure 계정**: 활성화된 Azure 구독이 필요

* **Azure CLI**: 시스템에 Azure CLI가 설치



# 3. ACR 생성

## 1) Azure 로그인



### (1) 구독 확인

먼저 Azure CLI를 통해 Azure에 로그인

```sh
$ az login
```



구독 확인

```sh
# 계정확인(구독)
$ az account list -o table
Name        CloudName    SubscriptionId                        TenantId                              State    IsDefault
----------  -----------  ------------------------------------  ------------------------------------  -------  -----------
playground  AzureCloud   3635a8be-5bb2-49ea-a43a-82c892f125e1  a3870566-f011-4691-aa51-5b988c51c03a  Enabled  False
axcoe       AzureCloud   1d6c45e0-bd9f-4771-bb67-36616452f239  a3870566-f011-4691-aa51-5b988c51c03a  Enabled  True


# axcoe 를 사용한다.
$ az account set --subscription axcoe


```



### (2) 리소스 그룹 확인 

```sh
# 확인
$ az group list -o table
Name                                                 Location       Status
---------------------------------------------------  -------------  ---------
VisualStudioOnline-7A05201964324B7399826CA968C5D4DF  southeastasia  Succeeded
NetworkWatcherRG                                     koreacentral   Succeeded
DefaultResourceGroup-SE                              koreacentral   Succeeded
tiu-axcoe-rg                                         koreacentral   Succeeded
ResourceMoverRG-koreasouth-koreacentral-krc          koreacentral   Succeeded
yjsong-rg                                            koreacentral   Succeeded



# 생성필요시
$ az group create --name axcoe-yj-rg --location koreacentral

{
  "id": "/subscriptions/1d6c45e0-bd9f-4771-bb67-36616452f239/resourceGroups/axcoe-yj-rg",
  "location": "koreacentral",
  "managedBy": null,
  "name": "axcoe-yj-rg",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null,
  "type": "Microsoft.Resources/resourceGroups"
}


# 확인
$ az group list -o table
Name                                                     Location       Status
-------------------------------------------------------  -------------  ---------
...
axcoe-yj-rg                                              koreacentral   Succeeded


# 삭제시
$ az group delete --name axcoe-yj-rg


```

* 리소스이름은 소문자로만 구성되어야 함







## 2) ACR 인스턴스 생성



### (1) ACR 생성

Azure Container Registry 인스턴스를 생성한다.

```sh
ACR_NAME=axcoeyjacr
ACR_NAME=axcoeyjpracr
RESOURCE_GROUP=axcoe-yj-rg



$ az acr create \
    --resource-group $RESOURCE_GROUP \
    --name $ACR_NAME \
    --sku Basic

#premium 으로
$ az acr create \
    --resource-group $RESOURCE_GROUP \
    --name $ACR_NAME \
    --sku Premium
    
    
$ az acr list -o table

NAME            RESOURCE GROUP    LOCATION      SKU      LOGIN SERVER               CREATION DATE         ADMIN ENABLED
--------------  ----------------  ------------  -------  -------------------------  --------------------  ---------------
axcoeyjacr      axcoe-yj-rg       koreacentral  Basic    axcoeyjacr.azurecr.io      2024-08-22T12:19:16Z  False
tiuaxcoetmpacr  tiu-axcoe-rg      koreacentral  Premium  tiuaxcoetmpacr.azurecr.io  2024-08-08T05:10:27Z  True
axcoeyjpracr    axcoe-yj-rg       koreacentral  Premium  axcoeyjpracr.azurecr.io    2024-08-22T13:34:22Z  False




# 삭제시...
$ az acr delete axcoeyjacr
$ az acr delete axcoeyjpracr


```

* 리소스이름은 소문자로만 구성되어야 함





### [참고] ACR SKU 옵션



**Basic**

* 저렴한 비용으로 ACR을 사용할 수 있다.
* 개발 및 테스트 시나리오에 적합하다.
* 저장소 용량: 최대 10GB.
* 웹 훅 지원: 제한적.



**Standard**

* 기본적인 컨테이너 이미지를 저장하고 관리할 때 적합하다.
* 저장소 용량: 최대 100GB.
* 더 많은 웹 훅 지원.
* 지리적 복제 지원 가능.



**Premium**

* 대규모 엔터프라이즈 애플리케이션에 적합하다.
* 저장소 용량: 최대 500GB.
* 고급 기능 제공: 더 많은 웹 훅, 전용 IP, 지리적 복제, 가상 네트워크 통합 등.







## 3) ACR List



```sh
$ az acr list
cepgstapacr


$ az acr list -o table
NAME         RESOURCE GROUP    LOCATION      SKU    LOGIN SERVER            CREATION DATE         ADMIN ENABLED
-----------  ----------------  ------------  -----  ----------------------  --------------------  ---------------
cepgbaseacr  cepg-aa-std-rg    koreacentral  Basic  cepgbaseacr.azurecr.io  2024-07-19T02:04:42Z  True
cepgstapacr  cepg-aa-std-rg    koreacentral  Basic  cepgstapacr.azurecr.io  2024-07-19T02:05:08Z  False




NAME            RESOURCE GROUP    LOCATION      SKU      LOGIN SERVER               CREATION DATE         ADMIN ENABLED
--------------  ----------------  ------------  -------  -------------------------  --------------------  ---------------
axcoeyjacr      axcoe-yj-rg       koreacentral  Basic    axcoeyjacr.azurecr.io      2024-08-22T12:19:16Z  False
tiuaxcoetmpacr  tiu-axcoe-rg      koreacentral  Premium  tiuaxcoetmpacr.azurecr.io  2024-08-08T05:10:27Z  True



```





# 4. ACR 인증처리





GitHub Actions 같은 CI 환경에서는 Azure Container Registry(ACR)에 로그인하기 위해 서비스 주체(Service Principal) 또는 ACR 관리 자격 증명을 사용하는 것이 일반적임

먼저 서비스 주체를 사용하여 ACR에 로그인하는 방법을 알아보자.



## 1) Azure 서비스주체

> Azure SP(Service Principal) 생성

Azure Portal 또는 Azure CLI를 사용하여 서비스 주체를 생성한다.



#### Azure CLI를 사용하여 서비스 주체 생성

```sh
# 변수 설정

ACR_NAME=axcoeyjacr
RESOURCE_GROUP=axcoe-yj-rg 
SERVICE_PRINCIPAL_NAME=myServicePrincipal     # <YourServicePrincipalName>


# acr id 확인
$ az acr show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query id --output tsv

/subscriptions/0cbb9123-6397-4a37-97d1-8efa0a25043b/resourceGroups/cepg-aa-std-rg/providers/Microsoft.ContainerRegistry/registries/cepgstapacr
/subscriptions/1d6c45e0-bd9f-4771-bb67-36616452f239/resourceGroups/axcoe-yj-rg/providers/Microsoft.ContainerRegistry/registries/axcoeyjacr




# SP생성1
$ az ad sp create-for-rbac \
    --name http://$SERVICE_PRINCIPAL_NAME \
    --role contributor \
    --scopes $(az acr show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query id --output tsv)

Creating 'contributor' role assignment under scope '/subscriptions/0cbb9123-6397-4a37-97d1-8efa0a25043b/resourceGroups/cepg-aa-std-rg/providers/Microsoft.ContainerRegistry/registries/cepgstapacr'
The output includes credentials that you must protect. Be sure that you do not include these credentials in your code or check the credentials into your source control. For more information, see https://aka.ms/azadsp-cli
{
  "appId": "136ad9d9-2b0b-4498-8d65-275ff3cd7f1b",
  "displayName": "http://myServicePrincipal",
  "password": "r9X8Q~7t7igypZaPz2e5oCt~lDCJTF37j9c_Cc8t",
  "tenant": "a3870566-f011-4691-aa51-5b988c51c03a"
}



# SP생성2 - AZURE_CREDENTIALS
$ az ad sp create-for-rbac \
    --name http://$SERVICE_PRINCIPAL_NAME \
    --sdk-auth \
    --role contributor \
    --scopes $(az acr show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query id --output tsv)

{
  "clientId": "136ad9d9-2b0b-4498-8d65-275ff3cd7f1b",
  "clientSecret": "-JL8Q~eIIwpkvxsY1a9I8YcEHwOlWf0imSk9baDv",
  "subscriptionId": "0cbb9123-6397-4a37-97d1-8efa0a25043b",
  "tenantId": "a3870566-f011-4691-aa51-5b988c51c03a",
  "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",
  "resourceManagerEndpointUrl": "https://management.azure.com/",
  "activeDirectoryGraphResourceId": "https://graph.windows.net/",
  "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",
  "galleryEndpointUrl": "https://gallery.azure.com/",
  "managementEndpointUrl": "https://management.core.windows.net/"
}


```



## 2) ACR 관리 자격 증명(ACR Login)

두번째 방법은 az acr login 하는 방법이다.  아래 에서 확인한다.





# 5. ACR 인증(az인증)

AZ ACR Login 방식으로 인증



## 1) Docker 확인

```sh
# Image pull (or build ...)
$ docker pull ssongman/userlist:v1


# 이미지 확인
$ docker images
REPOSITORY                            TAG       IMAGE ID       CREATED       SIZE
my_fastapi_app                        latest    6d6bd7d0f447   2 hours ago   209MB
ssongman/userlist                     v1        bf0cd99d0bad   5 years ago   680MB

```



## 2) 이미지 태그 지정

이미지에 태그를 지정하여 ACR로 푸시할 준비를 한다.

```sh
$ docker tag ssongman/userlist:v1 axcoeyjacr.azurecr.io/ssongman/userlist:v1


$ docker images

REPOSITORY                               TAG       IMAGE ID       CREATED       SIZE
my_fastapi_app                           latest    6d6bd7d0f447   2 hours ago   209MB
yjsongacr.azurecr.io/my_fastapi_app      latest    6d6bd7d0f447   2 hours ago   209MB
ssongman/userlist                        v1        bf0cd99d0bad   5 years ago   680MB
yjsongacr.azurecr.io/ssongman/userlist   v1        bf0cd99d0bad   5 years ago   680MB

axcoeyjacr.azurecr.io/ssongman/userlist  v1        bf0cd99d0bad   5 years ago    680MB



```





## 3) ACR 관리 자격 증명(ACR Login)

생성한 ACR 인스턴스에 로그인 한다.

```sh
$ az acr login --name axcoeyjacr

Login Succeeded

```





## 4) Push to ACR

이미지를 ACR로 푸시한다.

```sh
$ docker push yjsongacr.azurecr.io/my_fastapi_app:latest

$ docker push yjsongacr.azurecr.io/ssongman/userlist:v1

$ docker push axcoeyjacr.azurecr.io/ssongman/userlist:v1


# ok
```



## 5) ACR에서 이미지 확인

이미지가 ACR에 잘 푸시되었는지 확인한다.

```sh
$ az acr repository list --name axcoeyjacr --output table


Result
-----------------
ssongman/userlist


```

이후 Kubernetes나 Azure Container Instances (ACI)를 사용하여 이미지를 배포할 수 있음



## 6) Pull from ACR



```sh
$ docker login https://cepgstapacr.azurecr.io

$ docker pull cepgstapacr.azurecr.io/82023066/java-helloworld:lastest

$ docker pull axcoeyjacr.azurecr.io/ssongman/userlist:v1

```







# 6. ACR 인증(token방식)



관련링크 : https://learn.microsoft.com/en-us/azure/container-registry/container-registry-authentication?tabs=azure-cli



Az entra ID 를 이용한 개인 token 을 발급받아 ACR 에 접근하는 방법을 살펴본다.



## az acr login

```sh
ACR_NAME=axcoeyjacr

az acr login --name $ACR_NAME


# token 정보 json 추출
az acr login --name $ACR_NAME --expose-token

{
  "accessToken": "eyJhbGciOiJSUzI1NiIs[...]24V7wA",
  "loginServer": "myregistry.azurecr.io"
}

---

# token 만 추출
$ az acr login --name $ACR_NAME --expose-token --output tsv --query accessToken
eyJhbGciO...-sJaNszw

eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IlhLWUw6S1pSWDpRNU5UOlFKTk86RFRCVzpSM1dXOjNKWVM6NE9EWTpFVFJYOlk3VDI6WkY1WToyQUZNIn0.eyJqdGkiOiJjNzU0YzQ5NS0wMjhiLTQ5ZjItYWEyOC1iZGEyYzg3ZTI2MTQiLCJzdWIiOiI4MjI4ODE1MUBrdGRzcGxheWdyb3VuZG91dGxvb2sxMDAub25taWNyb3NvZnQuY29tIiwibmJmIjoxNzI0MzI5NDExLCJleHAiOjE3MjQzNDExMTEsImlhdCI6MTcyNDMyOTQxMSwiaXNzIjoiQXp1cmUgQ29udGFpbmVyIFJlZ2lzdHJ5IiwiYXVkIjoiYXhjb2V5amFjci5henVyZWNyLmlvIiwidmVyc2lvbiI6IjEuMCIsInJpZCI6ImI4ZDZkNjBiMjk0ODQ5ODJhYmJjYmFiMWU1ZDlkNjY4IiwiZ3JhbnRfdHlwZSI6InJlZnJlc2hfdG9rZW4iLCJhcHBpZCI6IjA0YjA3Nzk1LThkZGItNDYxYS1iYmVlLTAyZjllMWJmN2I0NiIsInRlbmFudCI6ImEzODcwNTY2LWYwMTEtNDY5MS1hYTUxLTViOTg4YzUxYzAzYSIsInBlcm1pc3Npb25zIjp7ImFjdGlvbnMiOlsicmVhZCIsIndyaXRlIiwiZGVsZXRlIiwibWV0YWRhdGEvcmVhZCIsIm1ldGFkYXRhL3dyaXRlIiwiZGVsZXRlZC9yZWFkIiwiZGVsZXRlZC9yZXN0b3JlL2FjdGlvbiJdfSwicm9sZXMiOltdfQ.BptyaTNNwX3wA8IGIvE9gTu30JY3wLlFgz0LtE0yLiwpSma2rBD_W1OGISIIjl6tgZeoQ7BnnrG3o27JCxd6U1CD5XkkXtHWum3idmi7pENfC6gHn7Mhw-5vR99gLzi0hat4PJS89WXl_aIHmpqEJ-PSrEkvyag1pfP5Eg5AgyHe2RrlVFcW8LdoHtyzcXH0ivC4-ziM-hAx5QmXZat1sRGWM8yOEQZ0S3xYlDlgG6MiLiLa8N5WG4iYKAXF5Ue4vVHCpypWbK9tGT-K1GzaM9YQXvXMoWZD-gxJZSKZnIWtp7P_IqK3wdV-RY2pL-tOp6J6tmVpJ_-YlCvOcHG6Qg



```





## docker login with expose-token

```sh
ACR_NAME=axcoeyjacr


# token
accessToken=$(az acr login --name $ACR_NAME --expose-token --output tsv --query accessToken)

echo $accessToken


$ docker login axcoeyjacr.azurecr.io \
    --username 00000000-0000-0000-0000-000000000000 \
    --password-stdin <<< $accessToken

Login Succeeded

```



## docker pull

```sh
$ docker pull axcoeyjacr.azurecr.io/ssongman/userlist:v1

$ docker pull axcoeyjacr.azurecr.io/82023066/java-helloworld

```









# 7. ACR 인증( admin user )



## 1) admin user 활성화

```sh
ACR_NAME=axcoeyjpracr
RESOURCE_GROUP=axcoe-yj-rg


$ az acr update \
    --name $ACR_NAME \
    --resource-group $RESOURCE_GROUP \
    --admin-enabled true


```



## 2) ACR 관리자 계정 정보 추출



```sh

ACR_NAME=axcoeyjpracr
RESOURCE_GROUP=axcoe-yj-rg

$ az acr credential show --name $ACR_NAME --resource-group $RESOURCE_GROUP


{
  "passwords": [
    {
      "name": "password",
      "value": "/DckvyKdmzxdRcUPIS0P4fPpJ4aTt+0x7JHvF/OhI5+ACRCZ50ew"
    },
    {
      "name": "password2",
      "value": "YgxvzDemPaVGPeDS6lQniOEQGYEbTag5jHGSRdGw/7+ACRBF443B"
    }
  ],
  "username": "axcoeyjacr"
}


```



## 3) docker login with 

```sh

accessToken=/DckvyKdmzxdRcUPIS0P4fPpJ4aTt+0x7JHvF/OhI5+ACRCZ50ew
accessToken=YgxvzDemPaVGPeDS6lQniOEQGYEbTag5jHGSRdGw/7+ACRBF443B
accessToken=/HgYhpO9uY0Osf3XxT/M0L+9ARBVxaFuYHyvkdMS8E+ACRBGYz52
echo $accessToken

$ docker login axcoeyjacr.azurecr.io \
    --username axcoeyjacr \
    --password-stdin <<< $accessToken

Login Succeeded

```











# 11. ACI 에 배포

> ACI(Azure Container Instance)



## 1) 컨테이너 그룹 생성 및 배포

ACI를 사용하여 "hello-world" 이미지를 배포

```sh
$ az container create \
    --resource-group yjsong-rg \
    --name yjsongaci \
    --image yjsongacr.azurecr.io/my_fastapi_app:latest \
    --cpu 1 --memory 1 \
    --registry-login-server yjsongacr.azurecr.io \
    --registry-username <ACR_USERNAME> \
    --registry-password <ACR_PASSWORD>


$ az container create \
    --resource-group yjsong-rg \
    --name yjsongaci \
    --image yjsongacr.azurecr.io/my_fastapi_app:latest \
    --cpu 1 --memory 1 \
    --registry-login-server yjsongacr.azurecr.io \
    --registry-username yjsongtoken \
    --registry-password 2w25XdMuYOdLOYr7MsRrVClR3pDdhV6jXu2UwbZRGo+ACRDvTQ4m

# 위 password 는 한달짜리 단기 사용


# 최초 실행이라면...
Resource provider 'Microsoft.ContainerInstance' used by this operation is not registered. We are registering for you.


```



## 2) 배포 상태 확인

컨테이너 인스턴스의 상태를 확인

```sh
$ az container show \
    --resource-group yjsong-rg \
    --name yjsongaci \
    --output table

Name       ResourceGroup    Status    Image                                       CPU/Memory       OsType    Location
---------  ---------------  --------  ------------------------------------------  ---------------  --------  ------------
yjsongaci  yjsong-rg        Running   yjsongacr.azurecr.io/my_fastapi_app:latest  1.0 core/1.0 gb  Linux     koreacentral

```







# ACR 설정



# 1. 개요

AKS 클러스터에서 Azure Container Registry (ACR)에서 이미지를 가져올 권한을 설정하는 방법에 대해서 살펴본다.

일반적으로 이를 위해 `Azure AD`의 `Managed Identity` 또는 `Service Principal`을 사용하여 AKS 클러스터에 ACR의 `pull` 권한을 부여할 수 있다.



# 2. AKS Managed Identity 에 ACR등록

가장 간단한 방법은 Azure CLI를 사용하여 AKS 클러스터의 `Managed Identity`에 ACR의 `pull` 권한을 부여하는 것이다.

* **Managed Identity**는 Azure 리소스에 대한 인증을 간소화하기 위해 사용되는 Azure AD 서비스이다. AKS 클러스터는 Managed Identity를 통해 Azure AD에서 인증을 받아 다른 Azure 리소스에 접근할 수 있다.
* AKS 클러스터를 생성할 때, AKS는 Azure AD에서 관리형 ID를 생성할 수 있다. 이 ID를 사용하여 AKS는 Azure Container Registry와 같은 다른 Azure 리소스에 접근할 수 있다.





## 1) AKS 클러스터에 권한 부여

먼저, AKS 클러스터에 연결된 Managed Identity 에 ACR 등록한다.



### (1) 구독 확인

```bash
# 구독 목록
$ az account list -o table

Name         CloudName    SubscriptionId                        TenantId                              State    IsDefault
-----------  -----------  ------------------------------------  ------------------------------------  -------  -----------
ce-pg-study  AzureCloud   0cbb9123-6397-4a37-97d1-8efa0a25043b  a3870566-f011-4691-aa51-5b988c51c03a  Enabled  False
axcoe        AzureCloud   1d6c45e0-bd9f-4771-bb67-36616452f239  a3870566-f011-4691-aa51-5b988c51c03a  Enabled  True


# 구독 변경
$ az account set --subscription axcoe

```



### (2) ACR 확인

```bash
# acr 확인
$ az acr list -o table

NAME            RESOURCE GROUP    LOCATION      SKU      LOGIN SERVER               CREATION DATE         ADMIN ENABLED
--------------  ----------------  ------------  -------  -------------------------  --------------------  ---------------
axcoeyjacr      axcoe-yj-rg       koreacentral  Basic    axcoeyjacr.azurecr.io      2024-08-22T12:19:16Z  True
axcoeyjpracr    axcoe-yj-rg       koreacentral  Premium  axcoeyjpracr.azurecr.io    2024-08-22T13:34:22Z  True
tiuaxcoetmpacr  tiu-axcoe-rg      koreacentral  Premium  tiuaxcoetmpacr.azurecr.io  2024-08-08T05:10:27Z  True


# ACR 리소스 ID 가져오기

ACR_NAME=axcoeyjacr

$ az acr show --name $ACR_NAME --query "id" --output tsv
/subscriptions/0cbb9123-6397-4a37-97d1-8efa0a25043b/resourceGroups/cepg-aa-std-rg/providers/Microsoft.ContainerRegistry/registries/cepgstapacr

/subscriptions/1d6c45e0-bd9f-4771-bb67-36616452f239/resourceGroups/axcoe-yj-rg/providers/Microsoft.ContainerRegistry/registries/axcoeyjpracr



$ ACR_ID=$(az acr show --name $ACR_NAME --query "id" --output tsv)
  echo $ACR_ID


```



### (3) AKS 설정

```bash
$ az aks list -o table


Name                     Location      ResourceGroup    KubernetesVersion    CurrentKubernetesVersion    ProvisioningState    Fqdn
-----------------------  ------------  ---------------  -------------------  --------------------------  -------------------  ------------------------------------------------------------------
tiu-axcoe-pri-aks        koreacentral  tiu-axcoe-rg     1.29                 1.29.7                      Succeeded            tiu-axcoe--tiu-axcoe-rg-1d6c45-vjqqk97w.hcp.koreacentral.azmk8s.io
tiu-axcoe-pub-cluster    koreacentral  tiu-axcoe-rg     1.29                 1.29.7                      Succeeded            tiu-axcoe--tiu-axcoe-rg-1d6c45-y8vbv466.hcp.koreacentral.azmk8s.io
tiu-axcoe-tmp-aks-clstr  koreacentral  tiu-axcoe-rg     1.29                 1.29.7                      Succeeded            tiu-axcoe-pet-malamute-6ocezwud.hcp.koreacentral.azmk8s.io
axcoeyjaks               koreacentral  axcoe-yj-rg      1.29                 1.29.7                      Succeeded            axcoeyjaks-axcoe-yj-rg-1d6c45-twzorgp4.hcp.koreacentral.azmk8s.io


# 변수 설정
ACR_NAME=axcoeyjacr
RESOURCE_GROUP=axcoe-yj-rg
AKS_CLUSTER_NAME=axcoeyjaks


# AKS 클러스터의 Managed Identity에 ACR의 pull 권한 부여
$ az aks update -n $AKS_CLUSTER_NAME -g $RESOURCE_GROUP --attach-acr $ACR_NAME



```

이 명령어는 AKS 클러스터의 Managed Identity에 ACR에 접근할 수 있는 `pull` 권한을 자동으로 부여한다.







### (4) [참고] ACR에 `pull` 권한 부여 수동 설정 (선택 사항)

만약 수동으로 권한을 설정하려는 경우, 아래 명령어를 사용할 수 있다.

```bash
# AKS 클러스터의 Managed Identity 또는 Service Principal ID 가져오기
CLIENT_ID=$(az aks show -g $RESOURCE_GROUP -n $AKS_CLUSTER_NAME --query "identityProfile.kubeletidentity.clientId" --output tsv)

# ACR에 `AcrPull` 역할 부여
$ az role assignment create --assignee $CLIENT_ID --role "AcrPull" --scope $ACR_ID


```



## 2) **AKS에서 ACR pull TEST**

권한이 부여된 이후, AKS 클러스터에서 ACR에 있는 이미지를 문제 없이 가져올 수 있어야 한다. 

```bash
$ kubectl create deploy userlist --image=axcoeyjacr.azurecr.io/ssongman/userlist:v1

```



## 3) **Managed Identity 사용 여부 확인**

`az aks show` 명령어를 사용하여 AKS 클러스터에 Managed Identity가 설정되어 있는지 확인할 수 있다.

```bash
AKS_CLUSTER_NAME=axcoeyjaks
RESOURCE_GROUP=axcoe-yj-rg

$ az aks show -n $AKS_CLUSTER_NAME -g $RESOURCE_GROUP --query "identity"

{
  "delegatedResources": null,
  "principalId": "90f5852b-26ba-4fb6-86d6-7a27fa3f384d",
  "tenantId": "a3870566-f011-4691-aa51-5b988c51c03a",
  "type": "SystemAssigned",
  "userAssignedIdentities": null
}


```

Managed Identity가 없을 경우, `SystemAssigned` 또는 `UserAssigned` Managed Identity를 추가로 설정해야 할 수도 있다.







# 3. Image pull secret

AKS에서 Azure Container Registry (ACR)의 이미지를 `imagePullSecrets`를 사용하여 pull하는 방법은, Kubernetes의 기본적인 비공개 레지스트리 인증 방식이다. 이 방식에서는 ACR에 접근할 수 있는 자격 증명(도커 로그인 정보)을 Kubernetes Secret으로 저장하고, 이를 Pod의 `imagePullSecrets`로 지정하여 이미지를 pull한다.



## 1) **ACR 로그인 정보 가져오기**

아래 두가지 중 하나로 정보를 획득 할 수 있다.



### (1) ACR 접근 user/pass 획득

ACR에 접근할 수 있는 관리자 계정의 사용자 이름과 비밀번호를 얻어야 한다. 다음 명령어를 사용하여 ACR의 자격 증명을 추출한다.

```bash
$ az acr credential show --name axcoeyjacr

{
  "passwords": [
    {
      "name": "password",
      "value": "/HgYhpO9uY0Osf3XxT/M0L+9ARBVxaFuYHyvkdMS8E+ACRBGYz52"
    },
    {
      "name": "password2",
      "value": "YgxvzDemPaVGPeDS6lQniOEQGYEbTag5jHGSRdGw/7+ACRBF443B"
    }
  ],
  "username": "axcoeyjacr"
}


```



### (2) service principal 생성

```bash
ACR_NAME=axcoeyjacr

# ACR RESOURCE ID 확인
$ az acr show --name $ACR_NAME --query id --output tsv

/subscriptions/1d6c45e0-bd9f-4771-bb67-36616452f239/resourceGroups/axcoe-yj-rg/providers/Microsoft.ContainerRegistry/registries/axcoeyjacr


# RESOURCE ID Set
ACR_RESOURCE_ID=$(az acr show --name $ACR_NAME --query id --output tsv)
echo $ACR_RESOURCE_ID


SP_NAME=myAcrSp
$ az ad sp create-for-rbac --name SP_NAME --scope $ACR_RESOURCE_ID --role acrpull




```

- 생성된 Service Principal은 ACR에서 이미지를 pull할 수 있는 권한을 갖도록 설정한다.
- 잘 안된다.    AuthorizationFailed 오류 발생!  그냥 위에 것으로 하자.





## 2) **Kubernetes Secret 생성**

ACR 자격 증명을 Kubernetes Secret으로 저장한다. `kubectl` 명령어를 사용하여 다음과 같이 Secret을 생성할 수 있다.

```bash

SECRET_NAME=acr-secret
ACR_NAME=axcoeyjacr
admin_username=axcoeyjacr
password_value=/HgYhpO9uY0Osf3XxT/M0L+9ARBVxaFuYHyvkdMS8E+ACRBGYz52
my_email=ssongmantop@gmail.com


$ kubectl create secret docker-registry $SECRET_NAME \
  --docker-server=$ACR_NAME.azurecr.io \
  --docker-username=$admin_username \
  --docker-password=$password_value \
  --docker-email=$my_email


# 확인
$ kubectl get secret $SECRET_NAME --output="jsonpath={.data.\.dockerconfigjson}" | base64 --decode

```

- **`<SECRET_NAME>`**: Kubernetes Secret의 이름이다. 예: `acr-secret`.
- **`<ACR_NAME>`**: Azure Container Registry의 이름이다.
- **`<admin_username>`**: ACR 자격 증명의 사용자 이름이다.
- **`<password_value>`**: ACR 자격 증명의 비밀번호이다.
- **`<your_email>`**: Docker 레지스트리의 이메일 주소이다. 일반적으로 이메일은 필수 입력 사항이 아니므로 사용하지 않더라도 상관없다.





## 3) **Pod 또는 Deployment에서 `imagePullSecrets` 사용**

이제, 생성한 Secret을 사용하여 Pod이나 Deployment에서 ACR 이미지를 pull할 수 있도록 설정한다.

**Pod의 예시 YAML 파일:**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp
spec:
  containers:
  - name: myapp-container
    image: myacr.azurecr.io/myapp:latest
  imagePullSecrets:
  - name: acr-secret
```

**Deployment의 예시 YAML 파일:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp-container
        image: myacr.azurecr.io/myapp:latest
      imagePullSecrets:
      - name: acr-secret
```

이 설정은 `myacr.azurecr.io`에서 `myapp:latest` 이미지를 pull할 때, 생성한 `acr-secret`을 사용하도록 Kubernetes에 지시한다.



## 4) **배포 및 확인**

위의 YAML 파일을 사용하여 Deployment를 배포한다.

```bash
kubectl apply -f deployment.yaml
```

배포가 성공적으로 이루어지면, 지정된 ACR로부터 이미지를 pull하여 Pod가 실행된다. 이를 확인하려면 다음 명령어를 사용한다.

```bash
kubectl get pods
```

Pod가 정상적으로 실행 중인지 확인한다. 만약 이미지 pull에 문제가 있을 경우, 로그를 확인하여 원인을 파악할 수 있다.



## 5) **요약**

`imagePullSecrets` 방식은 ACR에 대한 자격 증명을 Kubernetes Secret으로 저장하고, Pod에서 이미지를 pull할 때 이 Secret을 사용하는 방식이다. 이 방식은 ACR과 같은 비공개 Docker 레지스트리에서 이미지를 pull할 때 일반적으로 사용된다.

- **장점**: 특정 Pod나 Deployment에 대해 세밀하게 자격 증명을 관리할 수 있다.
- **단점**: 자격 증명 관리가 번거로울 수 있으며, 보안에 민감한 환경에서는 Managed Identity를 사용하는 방법이 더 적합할 수 있다.

이 방법을 통해 AKS에서 ACR 이미지를 pull하여 배포할 수 있다.







