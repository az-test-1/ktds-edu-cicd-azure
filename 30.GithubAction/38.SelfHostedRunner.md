# Github Action SelfHosted Runner



# 1. 개요

Github Action SelfHosted Runner 를 살펴본다.



# 2. [VM] self-hosted runner 추가

신규 VM 을 준비하고 아래와 같이 셋팅한다.





## 1) self-hosted runner 추가

신규 VM 을 준비하고 아래와 같이 셋팅한다.



### Download

```sh
# Create a folder
$ mkdir actions-runner && cd actions-runner

# Download the latest runner package
$ curl -o actions-runner-linux-x64-2.319.1.tar.gz -L https://github.com/actions/runner/releases/download/v2.319.1/actions-runner-linux-x64-2.319.1.tar.gz


# Optional: Validate the hash
$ echo "3f6efb7488a183e291fc2c62876e14c9ee732864173734facc85a1bfb1744464  actions-runner-linux-x64-2.319.1.tar.gz" | shasum -a 256 -c


# Extract the installer
$ tar xzf ./actions-runner-linux-x64-2.319.1.tar.gz

$ ll
total 213968
drwxr-xr-x 4 song song      4096 Aug 13 16:29 ./
drwxrwxr-x 3 song song      4096 Aug 23 15:12 ../
-rw-rw-r-- 1 song song 219048621 Aug 23 15:12 actions-runner-linux-x64-2.319.1.tar.gz
drwxr-xr-x 5 song song     16384 Aug 13 16:29 bin/
-rwxr-xr-x 1 song song      2458 Aug 13 16:29 config.sh*
-rwxr-xr-x 1 song song       646 Aug 13 16:29 env.sh*
drwxr-xr-x 6 song song      4096 Aug 13 16:29 externals/
-rw-r--r-- 1 song song      1619 Aug 13 16:29 run-helper.cmd.template
-rwxr-xr-x 1 song song      2663 Aug 13 16:29 run-helper.sh.template*
-rwxr-xr-x 1 song song      2535 Aug 13 16:29 run.sh*
-rwxr-xr-x 1 song song        65 Aug 13 16:29 safe_sleep.sh*


```



### Configure

```sh
# Create the runner and start the configuration experience
$ ./config.sh --url https://github.com/ssongman/heathcheck --token ADA2HNKN4ZUBCMK5GXQWZWTGZCYUA


# Authentication


√ Connected to GitHub

# Runner Registration

Enter the name of the runner group to add this runner to: [press Enter for Default]

Enter the name of runner: [press Enter for yj-runner]

This runner will have the following labels: 'self-hosted', 'Linux', 'X64'
Enter any additional labels (ex. label-1,label-2): [press Enter to skip]

√ Runner successfully added
√ Runner connection is good

# Runner settings

Enter name of work folder: [press Enter for _work]

√ Settings Saved.




# Last step, run it!
$ ./run.sh
```



### 실행



#### background 로 실행

```	sh
./svc.sh install
./svc.sh start

```



#### forground 로 실행

```sh
./run.sh

```



### Using your self-hosted runner

```sh
# Use this YAML in your workflow file for each job
runs-on: self-hosted

```





## 2) 결론

VM 에 az, docker 와 같은 tool 들이 기 설치 되어 있어야 한다.





# 3. [POD] pod 로 실행하는 방법



GitHub Actions의 Self-hosted runner를 Kubernetes Pod로 실행하는 방법은 Kubernetes 클러스터에서 GitHub Actions Runner를 직접 운영할 수 있는 매우 유연한 방식이다. 이를 통해 특정 리소스에 대한 접근 권한을 제어하거나 클러스터 내에서 효율적으로 워크플로우를 실행할 수 있다.

### **1) GitHub Actions Runner Docker 이미지 준비**

GitHub에서는 GitHub Actions Runner의 공식 Docker 이미지를 제공한다. 이를 사용하여 Kubernetes 클러스터에서 Pod로 실행할 수 있다.

- GitHub에서 제공하는 Docker 이미지를 사용하거나, 커스터마이징된 Docker 이미지를 직접 만들 수 있다.

### **2) Kubernetes 클러스터에 GitHub Runner Pod 설정**

Kubernetes 클러스터에 GitHub Actions Runner를 배포하기 위해 `Deployment`와 `ServiceAccount`를 정의할 수 있다.



```sh
$ k create ns github-runner

```





#### **2.1. ServiceAccount 및 Role 설정**

GitHub Runner가 Kubernetes에서 필요한 권한을 갖도록 설정해야 한다.

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: github-runner
  namespace: github-runner

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: github-runner-role
  namespace: github-runner
rules:
- apiGroups: [""]
  resources: ["pods", "pods/logs", "pods/exec"]
  verbs: ["get", "list", "create", "delete", "watch"]
- apiGroups: [""]
  resources: ["services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "statefulsets"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: github-runner-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: github-runner-role
subjects:
- kind: ServiceAccount
  name: github-runner
  namespace: github-runner
```



```bash
$ cd /song/github-runner
$ cat > 11.github-runner-rbac.yaml
...



$ kubectl -n github-runner apply -f 11.github-runner-rbac.yaml


```





#### **2.2. Deployment 설정**

GitHub Runner를 실행하는 `Deployment`를 작성한다. 이 Deployment는 GitHub에서 제공하는 공식 Runner 이미지를 사용한다.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: github-runner
  labels:
    app: github-runner
spec:
  replicas: 1
  selector:
    matchLabels:
      app: github-runner
  template:
    metadata:
      labels:
        app: github-runner
    spec:
      serviceAccountName: github-runner
      containers:
      - name: github-runner
        image: ghcr.io/actions/runner:latest
        env:
        - name: RUNNER_NAME
          value: "yj-self-hosted-runner"
        - name: RUNNER_REPOSITORY_URL
          value: "https://github.com/ssongman/heathcheck"
        - name: RUNNER_TOKEN
          value: "ADA2HNKZPQCHLKOH754ISX3GZHQ4S"
        - name: RUNNER_WORKDIR
          value: "/tmp/github-runner"
        - name: RUNNER_LABELS
          value: "self-hosted,Linux,X64"
        volumeMounts:
        - name: runner-workdir
          mountPath: /tmp/github-runner
      volumes:
      - name: runner-workdir
        emptyDir: {}
```

- **`image`**:
  - ghcr.io/actions/runner:latest     <-- 이런이미지 없음
  - ghcr.io/github/super-linter
  - mycustom/github-runner:latest   <-- 커스텀
  - github/k8s-actions-runner:latest

- **`RUNNER_REPOSITORY_URL`**: Runner가 연결될 GitHub 리포지토리의 URL.
- **`RUNNER_TOKEN`**: GitHub에서 제공한 Runner 등록 토큰. 이는 GitHub에서 생성하며, 해당 리포지토리의 설정에서 받을 수 있다.
- **`RUNNER_LABELS`**: Runner에 지정할 레이블입니다. 이를 통해 특정 Runner를 타겟으로 워크플로우를 실행할 수 있다.





```bash
$ cd /song/github-runner

$ cat > 12.github-runner-deployment.yaml
...

# 실행
$ kubectl -n github-runner apply -f 12.github-runner-deployment.yaml

# 삭제시....
$ kubectl -n github-runner delete -f 12.github-runner-deployment.yaml


```





#### 2.3. GitHub PAT

runner image 를 pull 권한이 있는 token을 사전 발급 받아야 함.



**GitHub에서 Personal Access Token (PAT) 생성**:

* GitHub에서 PAT를 생성. 해당 토큰에는 read:packages 권한이 필요
* [GitHub Settings](https://github.com/settings/tokens)에서 새로운 토큰을 생성하고, read:packages 권한을 부여





```sh

$ kubectl -n github-runner create secret docker-registry ghcr-credentials \
  --docker-server=ghcr.io \
  --docker-username=<YOUR_GITHUB_USERNAME> \
  --docker-password=<YOUR_PAT>


$ kubectl -n github-runner create secret docker-registry ghcr-credentials \
  --docker-server=ghcr.io \
  --docker-username=ssongman \
  --docker-password=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
  
  
  
```



* test

```sh
$ echo "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" | docker login ghcr.io -u ssongman --password-stdin

WARNING! Your password will be stored unencrypted in /home/song/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded



$ docker pull ghcr.io/actions/runner:latest
Error response from daemon: manifest unknown



$ docker pull ghcr.io/github/super-linter

# 용량이 어마무시하네...
$ docker images
REPOSITORY                                  TAG                  IMAGE ID       CREATED        SIZE
ghcr.io/github/super-linter                 latest               747d16400ee5   4 months ago   6.04GB


```







그리고 Deployment에서 이 Secret을 참조하여 이미지를 풀링

```sh
spec:
  containers:
  - name: github-runner
    image: ghcr.io/actions/runner:latest
  imagePullSecrets:
  - name: ghcr-credentials
  
```



### **3) GitHub 리포지토리에 Self-hosted Runner 등록**

GitHub 리포지토리에서 Runner를 등록하려면 GitHub에서 제공하는 명령을 사용해야 한다.

1. **Runner 등록 페이지로 이동**:
   - 리포지토리의 **Settings > Actions > Runners**로 이동한다.
   - **New self-hosted runner** 버튼을 클릭하고, OS를 선택한다.

2. **등록 토큰 생성**:
   - GitHub에서 제공하는 토큰을 얻습니다. 이 토큰은 Runner를 등록하는 데 필요한다.

3. **토큰을 환경 변수로 설정**:
   - 위의 Kubernetes `Deployment` 파일에서 환경 변수 `RUNNER_TOKEN`에 이 토큰을 입력한다.



### **4) Runner 작동 확인**

GitHub 리포지토리의 **Settings > Actions > Runners**에서 등록된 Runner가 활성화된 것을 확인할 수 있습니다. 이제 이 Runner를 사용하여 GitHub Actions 워크플로우를 실행할 수 있다.



### **결론**

이 가이드는 Kubernetes 클러스터에서 GitHub Actions Runner를 Self-hosted runner로 실행하는 방법을 설명한다. Kubernetes에서 Pod로 실행되는 GitHub Runner는 자체 인프라의 리소스를 활용하여 GitHub Actions 워크플로우를 실행할 수 있는 유연성을 제공한다. Runner는 설정한 리소스 파일을 통해 관리되며, 필요에 따라 리소스 사용을 조정할 수 있다.





# 4. ARC

https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/quickstart-for-actions-runner-controller



## 1) ARC 설치(CRD)

* 첫번째 방법 - chart GPT

```sh
NAMESPACE="arc-systems"
helm install arc \
    --namespace "${NAMESPACE}" \
    --create-namespace \
    oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set-controller
    
    
$ helm -n arc-systems list
NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                   APP VERSION
arc     arc-systems     1               2024-08-24 23:59:42.694850898 +0900 KST deployed        gha-runner-scale-set-controller-0.9.3   0.9.3


```





### [참고] chart download

```

helm pull oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set-controller
helm pull oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set


$ ll
-rw-r--r--  1 song song  15653 Aug 24 23:34 gha-runner-scale-set-0.9.3.tgz


```



## 2) runner 구성

### (1) pre-defined-secret



GITHUB_PAT 사전 설정 

https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/authenticating-to-the-github-api



#### PAT 생성

다음은 ARC 실행자에게 필요한 개인 액세스 토큰 범위 목록

- 메뉴
  - PAT > tokens(classic)
- Name : repo-runner
- 범위
  - Repository runners: `repo`
  - Organization runners: `admin:org`



#### Kubernetes secret

```sh
kubectl create ns arc-runners


kubectl -n arc-runners create secret generic pre-defined-secret \
   --namespace=arc-runners \
   --from-literal=github_token='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'
   
   

# --set githubConfigSecret: pre-defined-secret


```





### (2) helm install

```sh

INSTALLATION_NAME="arc-runner-set"
NAMESPACE="arc-runners"
GITHUB_CONFIG_URL="https://github.com/ssongman/heathcheck"



helm install "${INSTALLATION_NAME}" \
    --namespace "${NAMESPACE}" \
    --set githubConfigUrl="${GITHUB_CONFIG_URL}" \
    --set githubConfigSecret=pre-defined-secret \
    oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set



$ helm -n arc-runners list
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                      APP VERSION
arc-runner-set  arc-runners     1               2024-08-25 00:03:33.470002898 +0900 KST deployed        gha-runner-scale-set-0.9.3 0.9.3


$ k -n arc-systems get pod
NAME                                     READY   STATUS    RESTARTS   AGE
arc-gha-rs-controller-6fbb755685-8bzrq   1/1     Running   0          4m37s
arc-runner-set-754b578d-listener         1/1     Running   0          46s     <-- listener 가 생겼다.


```





## 3) runner scale sets 사용

```yaml
name: Actions Runner Controller Demo
on:
  workflow_dispatch:

jobs:
  Explore-GitHub-Actions:
    # You need to use the INSTALLATION_NAME from the previous step
    runs-on: arc-runner-set
    steps:
    - run: echo "🎉 This job uses runner scale set runners!"
    
```

