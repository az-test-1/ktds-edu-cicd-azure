# Github Action SelfHosted Runner



# 1. ê°œìš”

Github Action SelfHosted Runner ë¥¼ ì‚´í´ë³¸ë‹¤.



# 2. [VM] self-hosted runner ì¶”ê°€

ì‹ ê·œ VM ì„ ì¤€ë¹„í•˜ê³  ì•„ë˜ì™€ ê°™ì´ ì…‹íŒ…í•œë‹¤.





## 1) self-hosted runner ì¶”ê°€

ì‹ ê·œ VM ì„ ì¤€ë¹„í•˜ê³  ì•„ë˜ì™€ ê°™ì´ ì…‹íŒ…í•œë‹¤.



### Download

```sh
# Create a folder
$ mkdir actions-runner && cd actions-runner

# Download the latest runner package
$ curl -o actions-runner-linux-x64-2.319.1.tar.gz -L https://github.com/actions/runner/releases/download/v2.319.1/actions-runner-linux-x64-2.319.1.tar.gz


# Optional: Validate the hash
$ echo "3f6efb7488a183e291fc2c62876e14c9ee732864173734facc85a1bfb1744464  actions-runner-linux-x64-2.319.1.tar.gz" | shasum -a 256 -c


# Extract the installer
$ tar xzf ./actions-runner-linux-x64-2.319.1.tar.gz

$ ll
total 213968
drwxr-xr-x 4 song song      4096 Aug 13 16:29 ./
drwxrwxr-x 3 song song      4096 Aug 23 15:12 ../
-rw-rw-r-- 1 song song 219048621 Aug 23 15:12 actions-runner-linux-x64-2.319.1.tar.gz
drwxr-xr-x 5 song song     16384 Aug 13 16:29 bin/
-rwxr-xr-x 1 song song      2458 Aug 13 16:29 config.sh*
-rwxr-xr-x 1 song song       646 Aug 13 16:29 env.sh*
drwxr-xr-x 6 song song      4096 Aug 13 16:29 externals/
-rw-r--r-- 1 song song      1619 Aug 13 16:29 run-helper.cmd.template
-rwxr-xr-x 1 song song      2663 Aug 13 16:29 run-helper.sh.template*
-rwxr-xr-x 1 song song      2535 Aug 13 16:29 run.sh*
-rwxr-xr-x 1 song song        65 Aug 13 16:29 safe_sleep.sh*


```



### Configure

```sh
# Create the runner and start the configuration experience
$ ./config.sh --url https://github.com/ssongman/heathcheck --token ADA2HNKN4ZUBCMK5GXQWZWTGZCYUA


# Authentication


âˆš Connected to GitHub

# Runner Registration

Enter the name of the runner group to add this runner to: [press Enter for Default]

Enter the name of runner: [press Enter for yj-runner]

This runner will have the following labels: 'self-hosted', 'Linux', 'X64'
Enter any additional labels (ex. label-1,label-2): [press Enter to skip]

âˆš Runner successfully added
âˆš Runner connection is good

# Runner settings

Enter name of work folder: [press Enter for _work]

âˆš Settings Saved.




# Last step, run it!
$ ./run.sh
```



### ì‹¤í–‰



#### background ë¡œ ì‹¤í–‰

```	sh
./svc.sh install
./svc.sh start

```



#### forground ë¡œ ì‹¤í–‰

```sh
./run.sh

```



### Using your self-hosted runner

```sh
# Use this YAML in your workflow file for each job
runs-on: self-hosted

```





## 2) ê²°ë¡ 

VM ì— az, docker ì™€ ê°™ì€ tool ë“¤ì´ ê¸° ì„¤ì¹˜ ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤.





# 3. [POD] pod ë¡œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•



GitHub Actionsì˜ Self-hosted runnerë¥¼ Kubernetes Podë¡œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì€ Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ GitHub Actions Runnerë¥¼ ì§ì ‘ ìš´ì˜í•  ìˆ˜ ìˆëŠ” ë§¤ìš° ìœ ì—°í•œ ë°©ì‹ì´ë‹¤. ì´ë¥¼ í†µí•´ íŠ¹ì • ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ì œì–´í•˜ê±°ë‚˜ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ íš¨ìœ¨ì ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

### **1) GitHub Actions Runner Docker ì´ë¯¸ì§€ ì¤€ë¹„**

GitHubì—ì„œëŠ” GitHub Actions Runnerì˜ ê³µì‹ Docker ì´ë¯¸ì§€ë¥¼ ì œê³µí•œë‹¤. ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ Podë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

- GitHubì—ì„œ ì œê³µí•˜ëŠ” Docker ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, ì»¤ìŠ¤í„°ë§ˆì´ì§•ëœ Docker ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

### **2) Kubernetes í´ëŸ¬ìŠ¤í„°ì— GitHub Runner Pod ì„¤ì •**

Kubernetes í´ëŸ¬ìŠ¤í„°ì— GitHub Actions Runnerë¥¼ ë°°í¬í•˜ê¸° ìœ„í•´ `Deployment`ì™€ `ServiceAccount`ë¥¼ ì •ì˜í•  ìˆ˜ ìˆë‹¤.



```sh
$ k create ns github-runner

```





#### **2.1. ServiceAccount ë° Role ì„¤ì •**

GitHub Runnerê°€ Kubernetesì—ì„œ í•„ìš”í•œ ê¶Œí•œì„ ê°–ë„ë¡ ì„¤ì •í•´ì•¼ í•œë‹¤.

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: github-runner
  namespace: github-runner

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: github-runner-role
  namespace: github-runner
rules:
- apiGroups: [""]
  resources: ["pods", "pods/logs", "pods/exec"]
  verbs: ["get", "list", "create", "delete", "watch"]
- apiGroups: [""]
  resources: ["services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "statefulsets"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: github-runner-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: github-runner-role
subjects:
- kind: ServiceAccount
  name: github-runner
  namespace: github-runner
```



```bash
$ cd /song/github-runner
$ cat > 11.github-runner-rbac.yaml
...



$ kubectl -n github-runner apply -f 11.github-runner-rbac.yaml


```





#### **2.2. Deployment ì„¤ì •**

GitHub Runnerë¥¼ ì‹¤í–‰í•˜ëŠ” `Deployment`ë¥¼ ì‘ì„±í•œë‹¤. ì´ DeploymentëŠ” GitHubì—ì„œ ì œê³µí•˜ëŠ” ê³µì‹ Runner ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•œë‹¤.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: github-runner
  labels:
    app: github-runner
spec:
  replicas: 1
  selector:
    matchLabels:
      app: github-runner
  template:
    metadata:
      labels:
        app: github-runner
    spec:
      serviceAccountName: github-runner
      containers:
      - name: github-runner
        image: ghcr.io/actions/runner:latest
        env:
        - name: RUNNER_NAME
          value: "yj-self-hosted-runner"
        - name: RUNNER_REPOSITORY_URL
          value: "https://github.com/ssongman/heathcheck"
        - name: RUNNER_TOKEN
          value: "ADA2HNKZPQCHLKOH754ISX3GZHQ4S"
        - name: RUNNER_WORKDIR
          value: "/tmp/github-runner"
        - name: RUNNER_LABELS
          value: "self-hosted,Linux,X64"
        volumeMounts:
        - name: runner-workdir
          mountPath: /tmp/github-runner
      volumes:
      - name: runner-workdir
        emptyDir: {}
```

- **`image`**:
  - ghcr.io/actions/runner:latest     <-- ì´ëŸ°ì´ë¯¸ì§€ ì—†ìŒ
  - ghcr.io/github/super-linter
  - mycustom/github-runner:latest   <-- ì»¤ìŠ¤í…€
  - github/k8s-actions-runner:latest

- **`RUNNER_REPOSITORY_URL`**: Runnerê°€ ì—°ê²°ë  GitHub ë¦¬í¬ì§€í† ë¦¬ì˜ URL.
- **`RUNNER_TOKEN`**: GitHubì—ì„œ ì œê³µí•œ Runner ë“±ë¡ í† í°. ì´ëŠ” GitHubì—ì„œ ìƒì„±í•˜ë©°, í•´ë‹¹ ë¦¬í¬ì§€í† ë¦¬ì˜ ì„¤ì •ì—ì„œ ë°›ì„ ìˆ˜ ìˆë‹¤.
- **`RUNNER_LABELS`**: Runnerì— ì§€ì •í•  ë ˆì´ë¸”ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ íŠ¹ì • Runnerë¥¼ íƒ€ê²Ÿìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.





```bash
$ cd /song/github-runner

$ cat > 12.github-runner-deployment.yaml
...

# ì‹¤í–‰
$ kubectl -n github-runner apply -f 12.github-runner-deployment.yaml

# ì‚­ì œì‹œ....
$ kubectl -n github-runner delete -f 12.github-runner-deployment.yaml


```





#### 2.3. GitHub PAT

runner image ë¥¼ pull ê¶Œí•œì´ ìˆëŠ” tokenì„ ì‚¬ì „ ë°œê¸‰ ë°›ì•„ì•¼ í•¨.



**GitHubì—ì„œ Personal Access Token (PAT) ìƒì„±**:

* GitHubì—ì„œ PATë¥¼ ìƒì„±. í•´ë‹¹ í† í°ì—ëŠ” read:packages ê¶Œí•œì´ í•„ìš”
* [GitHub Settings](https://github.com/settings/tokens)ì—ì„œ ìƒˆë¡œìš´ í† í°ì„ ìƒì„±í•˜ê³ , read:packages ê¶Œí•œì„ ë¶€ì—¬





```sh

$ kubectl -n github-runner create secret docker-registry ghcr-credentials \
  --docker-server=ghcr.io \
  --docker-username=<YOUR_GITHUB_USERNAME> \
  --docker-password=<YOUR_PAT>


$ kubectl -n github-runner create secret docker-registry ghcr-credentials \
  --docker-server=ghcr.io \
  --docker-username=ssongman \
  --docker-password=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
  
  
  
```



* test

```sh
$ echo "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" | docker login ghcr.io -u ssongman --password-stdin

WARNING! Your password will be stored unencrypted in /home/song/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded



$ docker pull ghcr.io/actions/runner:latest
Error response from daemon: manifest unknown



$ docker pull ghcr.io/github/super-linter

# ìš©ëŸ‰ì´ ì–´ë§ˆë¬´ì‹œí•˜ë„¤...
$ docker images
REPOSITORY                                  TAG                  IMAGE ID       CREATED        SIZE
ghcr.io/github/super-linter                 latest               747d16400ee5   4 months ago   6.04GB


```







ê·¸ë¦¬ê³  Deploymentì—ì„œ ì´ Secretì„ ì°¸ì¡°í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ í’€ë§

```sh
spec:
  containers:
  - name: github-runner
    image: ghcr.io/actions/runner:latest
  imagePullSecrets:
  - name: ghcr-credentials
  
```



### **3) GitHub ë¦¬í¬ì§€í† ë¦¬ì— Self-hosted Runner ë“±ë¡**

GitHub ë¦¬í¬ì§€í† ë¦¬ì—ì„œ Runnerë¥¼ ë“±ë¡í•˜ë ¤ë©´ GitHubì—ì„œ ì œê³µí•˜ëŠ” ëª…ë ¹ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

1. **Runner ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™**:
   - ë¦¬í¬ì§€í† ë¦¬ì˜ **Settings > Actions > Runners**ë¡œ ì´ë™í•œë‹¤.
   - **New self-hosted runner** ë²„íŠ¼ì„ í´ë¦­í•˜ê³ , OSë¥¼ ì„ íƒí•œë‹¤.

2. **ë“±ë¡ í† í° ìƒì„±**:
   - GitHubì—ì„œ ì œê³µí•˜ëŠ” í† í°ì„ ì–»ìŠµë‹ˆë‹¤. ì´ í† í°ì€ Runnerë¥¼ ë“±ë¡í•˜ëŠ” ë° í•„ìš”í•œë‹¤.

3. **í† í°ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •**:
   - ìœ„ì˜ Kubernetes `Deployment` íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ `RUNNER_TOKEN`ì— ì´ í† í°ì„ ì…ë ¥í•œë‹¤.



### **4) Runner ì‘ë™ í™•ì¸**

GitHub ë¦¬í¬ì§€í† ë¦¬ì˜ **Settings > Actions > Runners**ì—ì„œ ë“±ë¡ëœ Runnerê°€ í™œì„±í™”ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì œ ì´ Runnerë¥¼ ì‚¬ìš©í•˜ì—¬ GitHub Actions ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.



### **ê²°ë¡ **

ì´ ê°€ì´ë“œëŠ” Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ GitHub Actions Runnerë¥¼ Self-hosted runnerë¡œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•œë‹¤. Kubernetesì—ì„œ Podë¡œ ì‹¤í–‰ë˜ëŠ” GitHub RunnerëŠ” ìì²´ ì¸í”„ë¼ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ í™œìš©í•˜ì—¬ GitHub Actions ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ìœ ì—°ì„±ì„ ì œê³µí•œë‹¤. RunnerëŠ” ì„¤ì •í•œ ë¦¬ì†ŒìŠ¤ íŒŒì¼ì„ í†µí•´ ê´€ë¦¬ë˜ë©°, í•„ìš”ì— ë”°ë¼ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ì„ ì¡°ì •í•  ìˆ˜ ìˆë‹¤.





# 4. ARC

https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/quickstart-for-actions-runner-controller



## 1) ARC ì„¤ì¹˜(CRD)

* ì²«ë²ˆì§¸ ë°©ë²• - chart GPT

```sh
NAMESPACE="arc-systems"
helm install arc \
    --namespace "${NAMESPACE}" \
    --create-namespace \
    oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set-controller
    
    
$ helm -n arc-systems list
NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                   APP VERSION
arc     arc-systems     1               2024-08-24 23:59:42.694850898 +0900 KST deployed        gha-runner-scale-set-controller-0.9.3   0.9.3


```





### [ì°¸ê³ ] chart download

```

helm pull oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set-controller
helm pull oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set


$ ll
-rw-r--r--  1 song song  15653 Aug 24 23:34 gha-runner-scale-set-0.9.3.tgz


```



## 2) runner êµ¬ì„±

### (1) pre-defined-secret



GITHUB_PAT ì‚¬ì „ ì„¤ì • 

https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/authenticating-to-the-github-api



#### PAT ìƒì„±

ë‹¤ìŒì€ ARC ì‹¤í–‰ìì—ê²Œ í•„ìš”í•œ ê°œì¸ ì•¡ì„¸ìŠ¤ í† í° ë²”ìœ„ ëª©ë¡

- ë©”ë‰´
  - PAT > tokens(classic)
- Name : repo-runner
- ë²”ìœ„
  - Repository runners: `repo`
  - Organization runners: `admin:org`



#### Kubernetes secret

```sh
kubectl create ns arc-runners


kubectl -n arc-runners create secret generic pre-defined-secret \
   --namespace=arc-runners \
   --from-literal=github_token='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'
   
   

# --set githubConfigSecret: pre-defined-secret


```





### (2) helm install

```sh

INSTALLATION_NAME="arc-runner-set"
NAMESPACE="arc-runners"
GITHUB_CONFIG_URL="https://github.com/ssongman/heathcheck"



helm install "${INSTALLATION_NAME}" \
    --namespace "${NAMESPACE}" \
    --set githubConfigUrl="${GITHUB_CONFIG_URL}" \
    --set githubConfigSecret=pre-defined-secret \
    oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set



$ helm -n arc-runners list
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                      APP VERSION
arc-runner-set  arc-runners     1               2024-08-25 00:03:33.470002898 +0900 KST deployed        gha-runner-scale-set-0.9.3 0.9.3


$ k -n arc-systems get pod
NAME                                     READY   STATUS    RESTARTS   AGE
arc-gha-rs-controller-6fbb755685-8bzrq   1/1     Running   0          4m37s
arc-runner-set-754b578d-listener         1/1     Running   0          46s     <-- listener ê°€ ìƒê²¼ë‹¤.


```





## 3) runner scale sets ì‚¬ìš©

```yaml
name: Actions Runner Controller Demo
on:
  workflow_dispatch:

jobs:
  Explore-GitHub-Actions:
    # You need to use the INSTALLATION_NAME from the previous step
    runs-on: arc-runner-set
    steps:
    - run: echo "ğŸ‰ This job uses runner scale set runners!"
    
```

