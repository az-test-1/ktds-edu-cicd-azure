# AKS 생성



# 1. 개요

AKS 생성과정을 가이드한다.



# 2. AKS 생성



## 1) **Azure CLI 설치 및 로그인**

- Azure CLI가 설치되어 있지 않다면 [Azure CLI 설치 가이드](https://docs.microsoft.com/ko-kr/cli/azure/install-azure-cli)에서 설치한다.

- 터미널을 열고 다음 명령어를 입력하여 Azure에 로그인한다.



```sh
  
$ az login --use-device-code

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code NAZN54T73 to authenticate.

Retrieving tenants and subscriptions for the selection...

[Tenant and subscription selection]

No     Subscription name    Subscription ID                       Tenant
-----  -------------------  ------------------------------------  --------
[1] *  ABC-Lab              bbe8692f-000e-471b-ba79-c5eec94ca3d0  기본 디렉터리

The default is marked with an *; the default tenant is '기본 디렉터리' and subscription is 'ABC-Lab' (bbe8692f-000e-471b-ba79-c5eec94ca3d0).

Select a subscription and tenant (Type a number or Enter for no changes): 1



Tenant: 기본 디렉터리
Subscription: ABC-Lab (bbe8692f-000e-471b-ba79-c5eec94ca3d0)

[Announcements]
With the new Azure CLI login experience, you can select the subscription you want to use more easily. Learn more about it and its configuration at https://go.microsoft.com/fwlink/?linkid=2271236


```



* 확인

```sh
# 구독 확인
$ az account list -o table

Name         CloudName    SubscriptionId                        TenantId                              State    IsDefault
-----------  -----------  ------------------------------------  ------------------------------------  -------  -----------
ABC-Lab      AzureCloud   bbe8692f-000e-471b-ba79-c5eec94ca3d0  a3870566-f011-4691-aa51-5b988c51c03a  Enabled  True


# 리소스 그룹 확인
$ az group list -o table
Name                                                 Location       Status
---------------------------------------------------  -------------  ---------
VisualStudioOnline-7D6B761D0F66415EBB1388A39DE1872D  southeastasia  Succeeded
VisualStudioOnline-8107C48B98EC4037B7693FB049632282  southeastasia  Succeeded
NetworkWatcherRG                                     koreacentral   Succeeded
abclab-dev-rg                                        koreacentral   Succeeded
abclab-dev-aks-mc-rg                                 koreacentral   Succeeded
abc-lab-sm                                           koreasouth     Succeeded
```


## 2) **AKS 클러스터 생성**



### (1) CLI 로 생성

#### AKS 클러스터 생성(개발)

```sh
export RG_NAME=abclab-dev-rg
export AKS_CLUSTER_NAME=abclab-dev-aks
export AKS_NODE_RG_NAME=abclab-dev-aks-mc-rg
export VNET_NAME=abclab-dev-vnet
export PRI_SUB_NAME=abclab-dev-pri-sub
export PUB_SUB_NAME=abclab-dev-pub-sub
export DB_SUB_NAME=abclab-dev-db-sub
export VM_SIZE=Standard_D4as_v5
export NODE_POOL=infrapool 
export SUBSCRP_ID=bbe8692f-000e-471b-ba79-c5eec94ca3d0

az aks create \
    --resource-group $RESOURCE_GROUP_NAME \
    --node-resource-group $AKS_NODE_RG_NAME \
    --name $AKS_CLUSTER_NAME \
    --nodepool-name $NODE_POOL \
    --nodepool-labels nodepool=infra \
    --node-count 2 \
    --node-vm-size $VM_SIZE \
    --network-plugin kubenet \
    --network-policy calico \
    --pod-cidr 172.16.0.0/16 \
    --service-cidr 192.168.126.0/24 \
    --dns-service-ip 192.168.126.10 \
    --vnet-subnet-id /subscriptions/${SUBSCRP_ID}/resourceGroups/${RG_NAME}/providers/Microsoft.Network/virtualNetworks/${VNET_NAME}/subnets/${PRI_SUB_NAME} \
    --generate-ssh-keys
```

#### AKS nodepool 추가(개발)

``` sh
export RG_NAME=abclab-dev-rg
export AKS_CLUSTER_NAME=abclab-dev-aks
export VM_SIZE=Standard_D4as_v5
export NODE_POOL=apppool 

az aks nodepool add \
    --cluster-name $AKS_CLUSTER_NAME \
    --name $NODE_POOL \
    --labels nodepool=apppool \
    --mode user \
    --resource-group $RG_NAME \
    --node-count 2 \
    --node-vm-size $VM_SIZE
```



### (2) AKS 확인

```sh
$ az aks list -o table

Name            Location      ResourceGroup    KubernetesVersion    CurrentKubernetesVersion    ProvisioningState    Fqdn
--------------  ------------  ---------------  -------------------  --------------------------  -------------------  -------------------------------------------------------------------
abclab-dev-aks  koreacentral  abclab-dev-rg    1.29                 1.29.7                      Succeeded            abclab-dev-abclab-dev-rg-bbe869-appw72du.hcp.koreacentral.azmk8s.io

```





### (3) Node Pool 에 Label 설정

* 메뉴 :  AKS
  * Settings > Node pools > node pool > 우측
  * Edit Labels
    * Nodepool : app
    * Nodepool : infra






## 3) **kubectl 설치 및 클러스터 연결**



kubectl을 설치(설치되어 있지 않은 경우에만 수행)

```sh
$ az aks install-cli

```



AKS 클러스터와 연결

```sh
$ az account show -o table

$ az account set --subscription "1d6c45e0-bd9f-4771-bb67-36616452f239"



$ az aks list -o table
Name            Location      ResourceGroup    KubernetesVersion    CurrentKubernetesVersion    ProvisioningState    Fqdn
--------------  ------------  ---------------  -------------------  --------------------------  -------------------  -------------------------------------------------------------------
abclab-dev-aks  koreacentral  abclab-dev-rg    1.29                 1.29.7                      Succeeded            abclab-dev-abclab-dev-rg-bbe869-appw72du.hcp.koreacentral.azmk8s.io




# 연결
export RG_NAME=abclab-dev-rg
export AKS_CLUSTER_NAME=abclab-dev-aks

$ az aks get-credentials \
    --name $AKS_CLUSTER_NAME \
    --resource-group $RG_NAME

Merged "abclab-dev-aks" as current context in ~/.kube/config



# 확인
$ kubectl config view
...




```





## 4) use-context

```sh
# 확인
$ kubectl config view

# get-context
$ kubectl config get-contexts
CURRENT   NAME                          CLUSTER                    AUTHINFO                                                       NAMESPACE
*         abclab-dev-aks                abclab-dev-aks             clusterUser_abclab-dev-rg_abclab-dev-aks
...


# use-context
$ kubectl config use-context abclab-dev-aks


```







## 5) Clean Up



```sh
# aks 확인
$ az aks list -o table

# aks 삭제시...
$ az aks delete --name abclab-dev-aks --resource-group abclab-dev-rg


```









