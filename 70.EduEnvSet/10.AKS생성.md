# AKS 생성



# 1. 개요

AKS 생성과정을 가이드 한다.



# 2. AKS 생성



## 1) **Azure CLI 설치 및 로그인**

- Azure CLI가 설치되어 있지 않다면 [Azure CLI 설치 가이드](https://docs.microsoft.com/ko-kr/cli/azure/install-azure-cli)에서 설치한다.

- 터미널을 열고 다음 명령어를 입력하여 Azure에 로그인한다.



```sh
  
$ az login  # az login --use-device-code

[Tenant and subscription selection]

No     Subscription name    Subscription ID                       Tenant
-----  -------------------  ------------------------------------  --------
[1]    ##########           f67329b1-68bf-4980-8f0e-1de9441ae4c0  기본 디렉터리
[2] *  ktds-edu-sub         a7360040-8c13-43d4-9f8d-16c77c517a5b  ktdsedu

The default is marked with an *; the default tenant is 'ktdsedu' and subscription is 'ktds-edu-sub' (a7360040-8c13-43d4-9f8d-16c77c517a5b).

Select a subscription and tenant (Type a number or Enter for no changes): 2

Tenant: ktdsedu
Subscription: ktds-edu-sub (a7360040-8c13-43d4-9f8d-16c77c517a5b)

[Announcements]
With the new Azure CLI login experience, you can select the subscription you want to use more easily. Learn more about it and its configuration at https://go.microsoft.com/fwlink/?linkid=2271236

If you encounter any problem, please open an issue at https://aka.ms/azclibug

[Warning] The login output has been updated. Please be aware that it no longer displays the full list of available subscriptions by default.



```



* 확인

```sh
# 구독 확인
$ az account list -o table


Name                  CloudName    SubscriptionId                        TenantId                              State    IsDefault
--------------------  -----------  ------------------------------------  ------------------------------------  -------  -----------
ktds-edu-sub          AzureCloud   a7360040-8c13-43d4-9f8d-16c77c517a5b  f6937904-9ad3-41ad-93de-cee02acb83d8  Enabled  True



# 리소스 그룹 확인
$ az group list -o table

Name        Location      Status
----------  ------------  ---------
ktdsedu-rg  koreacentral  Succeeded

```



## 2) **AKS 클러스터 생성**



### (1) CLI 로 생성

#### AKS 클러스터 생성(개발)

```sh

export SUBSCRP_ID=a7360040-8c13-43d4-9f8d-16c77c517a5b
export RG_NAME=ktdsedu-rg
export AKS_CLUSTER_NAME=ktdsedu-aks
export AKS_NODE_RG_NAME=ktdsedu-aks-mc-rg
export VM_SIZE=Standard_D2s_v3
export NODE_POOL=infrapool
export VNET_NAME=ktdsedu-vnet
export SUB_NAME=ktdsedu-sub

# Standard_D2s_v3  : vCPU:2, Mem:8GiB
# Standard_D4ds_v5 : vCPU:4, Mem:16GiB
       

az aks create \
    --resource-group $RG_NAME \
    --node-resource-group $AKS_NODE_RG_NAME \
    --name $AKS_CLUSTER_NAME \
    --nodepool-name $NODE_POOL \
    --nodepool-labels nodepool=infra \
    --location koreacentral
    --node-count 2 \
    --node-vm-size $VM_SIZE \
    --network-plugin kubenet \
    --network-policy calico \
    --pod-cidr 172.16.0.0/16 \
    --service-cidr 192.168.126.0/24 \
    --dns-service-ip 192.168.126.10 \
    --vnet-subnet-id /subscriptions/${SUBSCRP_ID}/resourceGroups/${RG_NAME}/providers/Microsoft.Network/virtualNetworks/${VNET_NAME}/subnets/${SUB_NAME} \
    --generate-ssh-keys


```



### (2) AKS 확인

```sh
$ az aks list -o table

Name         Location      ResourceGroup    KubernetesVersion    CurrentKubernetesVersion    ProvisioningState    Fqdn
-----------  ------------  ---------------  -------------------  --------------------------  -------------------  ----------------------------------------------------------------
ktdsedu-aks  koreacentral  ktdsedu-rg       1.29                 1.29.8                      Succeeded            ktdsedu-ak-ktdsedu-rg-a73600-hqsx8ki7.hcp.koreacentral.azmk8s.io


```



### (3) Node Pool 에 Label 설정

* 메뉴 :  AKS
  * Settings > Node pools > node pool > 우측
  * Edit Labels
    * Nodepool : app
    * Nodepool : infra




## 3) **kubectl 설치 및 클러스터 연결**



kubectl을 설치(설치되어 있지 않은 경우에만 수행)

```sh
$ az aks install-cli

```



AKS 클러스터와 연결

```sh


$ az account list -o table
Name                  CloudName    SubscriptionId                        TenantId                              State    IsDefault
--------------------  -----------  ------------------------------------  ------------------------------------  -------  -----------
ktds-edu-sub          AzureCloud   a7360040-8c13-43d4-9f8d-16c77c517a5b  f6937904-9ad3-41ad-93de-cee02acb83d8  Enabled  True


$ az account set --subscription "ktds-edu-sub"



$ az aks list -o table
Name         Location      ResourceGroup    KubernetesVersion    CurrentKubernetesVersion    ProvisioningState    Fqdn
-----------  ------------  ---------------  -------------------  --------------------------  -------------------  ----------------------------------------------------------------
ktdsedu-aks  koreacentral  ktdsedu-rg       1.29                 1.29.8                      Succeeded            ktdsedu-ak-ktdsedu-rg-a73600-hqsx8ki7.hcp.koreacentral.azmk8s.io




# 연결
export RG_NAME=ktdsedu-rg
export AKS_CLUSTER_NAME=ktdsedu-aks

$ az aks get-credentials \
    --name $AKS_CLUSTER_NAME \
    --resource-group $RG_NAME

Merged "abclab-dev-aks" as current context in ~/.kube/config



# 확인
$ kubectl config view
...

```





## 4) use-context

```sh
# 확인
$ kubectl config view


# get-context
$ kubectl config get-contexts
CURRENT   NAME                          CLUSTER                    AUTHINFO                                                       NAMESPACE
*         ktdsedu-aks                   ktdsedu-aks                clusterUser_ktdsedu-rg_ktdsedu-aks


# use-context
$ kubectl config use-context ktdsedu-aks

```







## 5) Clean Up



```sh
# aks 확인
$ az aks list -o table

# aks 삭제시...
$ az aks delete --name ktdsedu-aks --resource-group ktdsedu-rg


```







# 3. AKS Stop/Start



```sh
# 1) aks 확인
$ az aks list -o table


RG_NAME=ktdsedu-rg
AKS_CLUSTER_NAME=ktdsedu-aks





# 2) stop
az aks stop --name $AKS_CLUSTER_NAME --resource-group $RG_NAME

# 확인
az aks list -o table
Name         Location      ResourceGroup    KubernetesVersion    CurrentKubernetesVersion    ProvisioningState    Fqdn
-----------  ------------  ---------------  -------------------  --------------------------  -------------------  ----------------------------------------------------------------
ktdsedu-aks  koreacentral  ktdsedu-rg       1.29                 1.29.8                      Stopping             ktdsedu-ak-ktdsedu-rg-a73600-hqsx8ki7.hcp.koreacentral.azmk8s.io





# 3) Start
az aks start --name $AKS_CLUSTER_NAME --resource-group $RG_NAME




```









