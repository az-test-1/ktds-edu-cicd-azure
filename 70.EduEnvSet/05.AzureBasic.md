# Azure Basic





# 1. Azure 리소스 구성



## 1) 관리그룹





![Azure 리소스 구성](./assets/scope-levels.png)





* 리소스
  * VM, network, SQL 등 사용자가 만드는 서비스의 인스턴스

* 리소스 그룹
  * 리소스들의 집합, 한꺼번에 삭제 가능함
* 구독
  * 구독은 사용자 계정과 해당 사용자 계정에서 만든 리소스를 그룹화함,
  * 각 구독에 대해 만들고 사용할 수 있는 리소스의 양에 대한 제한 또는 할당량 존재
  * 조직에서는 구독을 사용하여 사용자, 팀 또는 프로젝트에서 만든 리소스에 대한 비용 관리 가능
  * 구독 단위로 비용을 지불
* 관리그룹
  * 구독에 대한 액세스, 정책 및 규정준수를 관리
  * 상속 가능





## 2) 구독

### (1) 구독유형

* **무료 체험**
  * Azure 서비스를 무료로 시험해 볼 수 있는 구독
* **Pay-As-You-Go**
  * 사용한 만큼 비용을 지불하는 유연한 구독 유형
  * 고객이 원하는 대로 리소스를 확장하거나 축소 가능
* **Enterprise Agreement**
  * 기업 고객을 대상으로 한 구독 유형
  * 볼륨 할인 및 사용량에 따른 추가 혜택을 제공
* Microsoft Entra ID
* 학생 혜택에 액세스



### (2) 구독과 계정의 관계

아래 구조

* 계정에는 아래와 같은 구독들을 가질 수 있다.
  * 구독(개발)
  * 구독(테스트)
  * 구독(운영)







# 2. Setting



## 1) 비용관리+청구

* 메뉴 : 비용관리+청구

  * 청구 > 결제방법 > 결제 방법 추가

  * 결제 카드 등록

    



## 2) 구독추가

Ktds-edu-sub



## 3) 사용자 추가



### (1) 내부 사용자 추가

* 메뉴 : 홈 > 기본디렉토리 
  * Micro Entra ID 로 검색
    * 이전에는 Azure  Active Directory 였으나 이름이 변경됨
* 사용자관리
  * 사용자 > 새 사용자 만들기
    * 사용계정이름
      * yj.song
      * ssongmantopgmail.onmicrosoft.com
    * 표시이름 : 송양종
    * 암호 : password
    * 계정사용 : Check
    * 검토 + 만들기 > 만들기



### (2) [참고] 외부 사용자 추가

azure portal 에 로그인 가능한 사외 계정이 있는 경우 외부 사용자로 추가할 수 있다.

* 메뉴 : 홈 > 기본디렉토리 
  * Micro Entra ID 로 검색
    * 이전에는 Azure  Active Directory 였으나 이름이 변경됨
* 사용자관리
  * 사용자 > 외부사용자초대
* 외부사용자 초대
  * 게스트 사용자 정보 입력
    * 메일 : ssongmantop@gmail.com
    * 표시이름 : 송양종
    * 초대메시지 : Dio 프로젝트에 참여해 주세요
  * 설정확인 및 초대 전송
* 외부사용자가 메일로 수락
* 게스트 사용자 권한 부여
  * Users(사용자)
  * 할당된역할 >  할당 추가
  * 필요한 역할 선택후 추가
    * 예를들면 전역관리자
    * 기타...



## 4) 사용자추가 with CLI

Azure CLI를 사용하면 효율적으로 여러 사용자를 추가할 수 있다. 

아래 단계에 따라 **Azure AD 사용자**를 생성할 수 있다.



### (1) 단일 사용자 생성

```bash

# 생성
az ad user create \
  --display-name '송양종2' \
  --user-principal-name 'yj2.song@ssongmantopgmail.onmicrosoft.com' \
  --password 'Ktds1234!'
  
{
  "@odata.context": "https://graph.microsoft.com/v1.0/$metadata#users/$entity",
  "businessPhones": [],
  "displayName": "SONGYANGJONG2",
  "givenName": null,
  "id": "9980d12f-bcc5-424c-bd72-0d1b2928479d",
  "jobTitle": null,
  "mail": null,
  "mobilePhone": null,
  "officeLocation": null,
  "preferredLanguage": null,
  "surname": null,
  "userPrincipalName": "yj2.song@ssongmantopgmail.onmicrosoft.com"
}



# 확인1
$ az ad user list -o table
DisplayName    GivenName    Surname    UserPrincipalName
-------------  -----------  ---------  -----------------------------------------------------------
song yj        yj           song       ssongmantop_gmail.com#EXT#@ssongmantopgmail.onmicrosoft.com
송양종                                   yj.song@ssongmantopgmail.onmicrosoft.com
SONGYANGJONG2                          yj2.song@ssongmantopgmail.onmicrosoft.com


# 확인2
$ az ad user list --query '[].{Name: displayName, UPN: userPrincipalName, ID: id}' -o table

Name     UPN                                                          ID
-------  -----------------------------------------------------------  ------------------------------------
song yj  ssongmantop_gmail.com#EXT#@ssongmantopgmail.onmicrosoft.com  20f224c0-7fbf-45d4-b4b7-3019b1de4a19
송양종      yj.song@ssongmantopgmail.onmicrosoft.com                     70e2a3dd-b7a3-422a-9bae-90250cf6bacb
송양종2     yj2.song@ssongmantopgmail.onmicrosoft.com                    18c87ec3-654e-419e-b71a-8082e76c1796


# 확인3 : 사용자 계정으로 Object ID 가져오기
$ user_id=$(az ad user show --id "yj2.song@ssongmantopgmail.onmicrosoft.com" --query id --output tsv)
  echo $user_id

# 삭제시...
$ az ad user delete --id "18c87ec3-654e-419e-b71a-8082e76c1796"


```

- **`--display-name`**: 사용자의 표시 이름.
- **`--user-principal-name`**: 사용자의 로그인 이름(이메일 형식).
- **`--password`**: 사용자 계정의 초기 암호.





### (2) **대량 사용자 생성**
20명의 사용자를 일괄적으로 생성하려면 **Bash 스크립트**를 작성하여 여러 사용자를 한 번에 생성할 수 있습니다.

#### 예시 Bash 스크립트

```sh

$ mkdir -p ~/song/ktdsedu/createuser
  cd ~/song/ktdsedu/createuser

```



#### 사용자 정보를 파일로 저장

```sh

$ cat > user_list.txt <<EOL
yj2.song,송양종2
user1,사용자1
user2,사용자2
EOL
```



#### 스크립트

```bash

$ cat > create_users.sh
---
#!/bin/bash

while IFS=, read -r username display_name; do
    az ad user create \
      --display-name "$display_name" \
      --user-principal-name "$username@ssongmantopgmail.onmicrosoft.com" \
      --password "Ktds1234!"

    echo "사용자 $display_name ($username@ssongmantopgmail.onmicrosoft.com) 생성 완료."
done < user_list.txt
---



# 실행
$ bash create_users.sh


```



#### 삭제 스크립트

```sh

$ cat > delete_users_all.sh
---
#!/bin/bash

while IFS=, read -r username display_name; do
    echo "Processing user: $username ($display_name)"
    
    user_id=$(az ad user show --id "$username@ssongmantopgmail.onmicrosoft.com" --query id --output tsv)
    
    if [ -n "$user_id" ]; then
        echo "Deleting user: $username ($user_id)"
        az ad user delete --id "$user_id"
    else
        echo "User not found: $username"
    fi
    
done < user_list.txt
---


# 실행
$ bash delete_users_all.sh

```







## 4) 구독 권한 부여

* 메뉴 : 홈 > 구독
* 구독선택
* IAM > 추가 > 역할 할당 추가
  * 역할
    * 아래 Role 중에 적절한 것을 선택한다.
    * 소유자
    * 기여자
    * 기타
  * 구성원
    * 사용자추가
  * 조건
    * 소유자일땐 조건 입력 필요
  * 검토+할당 > 생성





# 3. Naming Rule



* 구독명
  * Ktds-edu-sub
* 리소스그룹
  * Ktdsedu-rg
* AKS
  * ktdseduacr
* ACR
  * ktdseduacr

​	